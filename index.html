<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Analizador de Ventas ‚Äì Tabla Din√°mica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Estilos simples -->
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { background: #0f172a; color: #e5e7eb; min-height: 100vh; padding: 1rem; }
    h1 { font-size: 1.5rem; margin-bottom: 0.3rem; }
    .sub { font-size: 0.8rem; margin-bottom: 0.8rem; color: #cbd5f5; }
    .panel {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 1rem;
    }
    @media (max-width: 900px){ .panel{ grid-template-columns: 1fr; } }

    .card {
      background: #020617;
      border-radius: 0.8rem;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 0.8rem;
    }
    label { font-size: 0.8rem; margin-bottom: 0.25rem; display: block; }
    input[type="file"] {
      width: 100%;
      padding: 0.4rem;
      border-radius: 0.4rem;
      border: 1px solid rgba(148,163,184,0.6);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
    }
    .hint { font-size: 0.75rem; color: #9ca3af; margin-top: 0.3rem; line-height: 1.3; }
    #status { font-size: 0.8rem; margin-top: 0.4rem; }

    #output {
      background: #020617;
      border-radius: 0.8rem;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 0.4rem;
      min-height: 80px;
      overflow: auto;
    }

    .pvtUi, .pvtTable { font-size: 0.75rem; }
  </style>

  <!-- PivotTable CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.css" />

  <!-- Librer√≠as JS (orden IMPORTANTE) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>Analizador de Ventas</h1>
  <div class="sub">
    Sube tu archivo de ventas (facturas) y arma tablas din√°micas tipo Excel (incluye campos A√±o / Mes).
  </div>

  <div class="panel">
    <!-- Lado izquierdo -->
    <div class="card">
      <label for="file-input">Archivo CSV de ventas</label>
      <input type="file" id="file-input" accept=".csv,text/csv" />
      <div class="hint">
        Debe tener columnas como:<br>
        factura, fecha, estatus, descuento, subt_fac, total_fac, iva, id cliente,
        id clase, clave, cant_surt, cve_mon, unidad, cve_suc, id vendedor, cliente,
        producto, cantidad pz, almacen, hora, costoprom2, marca, costo1, vendedor,
        filtro1, filtro2, filtro3, Tipo de Factura, costo2, utilidad, margen, categoria.
      </div>
      <div id="status">Sin archivo cargado.</div>

      <div class="hint" style="margin-top:0.8rem;">
        üëâ Para comparar mismo mes a√±o vs a√±o:<br>
        1. En la tabla din√°mica usa el campo derivado <b>Mes Nombre</b> en Filtros.<br>
        2. Usa <b>A√±o</b> en Columnas.<br>
        3. Usa <b>cve_suc</b> o <b>categoria</b> en Filas.<br>
        4. Usa <b>total_fac</b> como Valor (Sum).
      </div>
    </div>

    <!-- Lado derecho -->
    <div class="card">
      <div id="output">
        <div class="hint">Cambia tu CSV a .csv, s√∫belo y aqu√≠ aparecer√° la tabla din√°mica.</div>
      </div>
    </div>
  </div>

  <script>
    // === utilidades ===
    function normalizarNombre(str) {
      return String(str)
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "")
        .replace(/_/g, "");
    }

    function encontrarColumna(headers, posibles) {
      const normHeaders = headers.map(h => normalizarNombre(h));
      for (const alias of posibles) {
        const na = normalizarNombre(alias);
        const idx = normHeaders.indexOf(na);
        if (idx >= 0) return headers[idx];
      }
      return null;
    }

    function parseFecha(raw) {
      if (!raw) return null;
      const s = String(raw).trim();
      // yyyy-mm-dd o yyyy/mm/dd
      let m = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
      if (m) return { year: +m[1], month: +m[2] };
      // dd-mm-yyyy o dd/mm/yyyy
      m = s.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
      if (m) return { year: +m[3], month: +m[2] };
      const d = new Date(s);
      if (!isNaN(d)) return { year: d.getFullYear(), month: d.getMonth() + 1 };
      return null;
    }

    const MESES = ["","enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];

    // === carga de archivo ===
    document.getElementById('file-input').addEventListener('change', function (e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      document.getElementById('status').textContent = 'Leyendo archivo...';

      Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function (results) {
          let data = results.data || [];
          if (!data.length) {
            document.getElementById('status').textContent = 'Archivo sin registros.';
            return;
          }

          // limpiar encabezados: quitar espacios basura
          data = data.map(row => {
            const nuevo = {};
            Object.keys(row).forEach(k => {
              const limpio = k.trim();
              nuevo[limpio] = row[k];
            });
            return nuevo;
          });

          const headers = Object.keys(data[0]);

          const fechaCol = encontrarColumna(headers, ["fecha"]);
          const totalCol = encontrarColumna(headers, ["totalfac","total_fac","total"]);
          const sucCol   = encontrarColumna(headers, ["cvesuc","cve_suc"]);
          const vendedorCol = encontrarColumna(headers, ["vendedor"]);
          const categoriaCol = encontrarColumna(headers, ["categoria","categor√≠a"]);

          document.getElementById('status').textContent =
            "Archivo cargado: " + file.name + " (" + data.length + " filas).";

          crearPivot(data, { fechaCol, totalCol, sucCol, vendedorCol, categoriaCol });
        },
        error: function (err) {
          document.getElementById('status').textContent = 'Error al leer CSV: ' + err.message;
        }
      });
    });

    function crearPivot(data, meta) {
      const renderers = $.pivotUtilities.renderers;

      const derived = {};
      if (meta.fechaCol) {
        derived["A√±o"] = function (row) {
          const f = parseFecha(row[meta.fechaCol]);
          return f ? f.year : "";
        };
        derived["Mes"] = function (row) {
          const f = parseFecha(row[meta.fechaCol]);
          return f ? f.month : "";
        };
        derived["Mes Nombre"] = function (row) {
          const f = parseFecha(row[meta.fechaCol]);
          return f ? MESES[f.month] : "";
        };
      }

      const rows = meta.sucCol ? [meta.sucCol] : [];
      const cols = meta.fechaCol ? ["A√±o"] : [];
      const vals = [];
      let aggregator = "Count";
      if (meta.totalCol) {
        vals.push(meta.totalCol);
        aggregator = "Sum";
      }

      $("#output").empty();

      try {
        $("#output").pivotUI(
          data,
          {
            renderers: renderers,
            derivedAttributes: derived,
            rows: rows,
            cols: cols,
            vals: vals,
            aggregatorName: aggregator,
            rendererName: "Table"
          },
          true
        );
      } catch (e) {
        console.error(e);
        document.getElementById('output').innerHTML =
          '<div style="color:#fca5a5;font-size:0.8rem;">Error al generar la tabla din√°mica: ' +
          e.message + '</div>';
      }
    }
  </script>
</body>
</html>
