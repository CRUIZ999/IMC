<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Ventas ‚Äì Ferreter√≠a El Cedro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Estilos b√°sicos -->
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { background: #0f172a; color: #e5e7eb; min-height: 100vh; display: flex; flex-direction: column; }

    header {
      padding: 0.9rem 1.4rem;
      background: linear-gradient(90deg, #ea580c, #f97316);
      color: #0f172a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    header h1 { font-size: 1.4rem; font-weight: 800; display: flex; align-items: center; gap: 0.5rem; }
    header h1 span.logo {
      width: 34px; height: 34px; border-radius: 999px;
      display: inline-flex; align-items: center; justify-content: center;
      background: #0f172a; color: #f97316;
    }
    header .subtitle { font-size: 0.8rem; }

    main {
      max-width: 1500px;
      width: 100%;
      margin: 0 auto;
      padding: 1.1rem 1.4rem 1.6rem;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 1rem;
    }
    @media (max-width: 1024px) { main { grid-template-columns: 1fr; } }

    .card {
      background: #020617;
      border-radius: 0.9rem;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 0.9rem 1rem;
      box-shadow: 0 16px 35px rgba(15,23,42,0.8);
    }
    .card h2 {
      font-size: 0.95rem;
      margin-bottom: 0.55rem;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .card h2 .icon { font-size: 1rem; }

    .sidebar { display: flex; flex-direction: column; gap: 0.75rem; }
    .field { margin-bottom: 0.45rem; }
    label { font-size: 0.78rem; color: #9ca3af; margin-bottom: 0.15rem; display: block; }

    select, input[type="file"], input[type="number"], button {
      width: 100%;
      padding: 0.4rem 0.55rem;
      border-radius: 0.45rem;
      border: 1px solid rgba(148,163,184,0.5);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.82rem;
      outline: none;
    }
    select:focus, input[type="file"]:focus, input[type="number"]:focus {
      border-color: #f97316;
      box-shadow: 0 0 0 1px rgba(249,115,22,0.7);
    }
    button {
      background: linear-gradient(135deg, #fb923c, #f97316);
      color: #0f172a;
      border: none;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 10px 22px rgba(249,115,22,0.6);
      transition: transform 0.08s ease, box-shadow 0.08s ease;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(1px) scale(0.99); box-shadow: 0 6px 15px rgba(249,115,22,0.5); }
    .btn-secondary {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow: none;
    }

    .hint { font-size: 0.72rem; color: #9ca3af; margin-top: 0.25rem; line-height: 1.3; }
    hr { border: none; border-top: 1px dashed rgba(148,163,184,0.45); margin: 0.6rem 0; }

    .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.4rem; }

    .tabs { display: flex; gap: 0.4rem; margin-bottom: 0.5rem; }
    .tab-btn {
      flex: 1;
      text-align: center;
      padding: 0.35rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 0.8rem;
      cursor: pointer;
      background: #020617;
      color: #e5e7eb;
    }
    .tab-btn.active {
      background: #f97316;
      color: #0f172a;
      border-color: #f97316;
    }

    .content-area { display: flex; flex-direction: column; gap: 0.8rem; }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(170px,1fr));
      gap: 0.6rem;
    }
    .kpi {
      padding: 0.45rem 0.6rem;
      border-radius: 0.8rem;
      border: 1px solid rgba(148,163,184,0.5);
      background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(30,64,175,0.6));
    }
    .kpi .label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: .08em; color: #9ca3af; }
    .kpi .value { font-size: 1.1rem; font-weight: 800; }
    .kpi .sub { font-size: 0.7rem; color: #9ca3af; }

    .flex-row { display: flex; flex-wrap: wrap; gap: 0.75rem; }
    .flex-col { flex: 1 1 280px; min-width: 0; }

    table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
    th, td { padding: 0.3rem 0.4rem; border-bottom: 1px solid rgba(55,65,81,0.9); white-space: nowrap; text-align: right; }
    th { background: rgba(15,23,42,0.95); position: sticky; top: 0; z-index: 5; text-align: left; text-transform: uppercase; font-size: 0.7rem; }
    td:first-child, th:first-child { text-align: left; }
    tbody tr:nth-child(even) { background: rgba(15,23,42,0.7); }

    .table-container {
      max-height: 260px;
      overflow: auto;
      border-radius: 0.7rem;
      border: 1px solid rgba(75,85,99,0.9);
      background: radial-gradient(circle at top, rgba(148,163,184,0.25), rgba(15,23,42,0.95));
    }

    .empty-state { font-size: 0.78rem; color: #9ca3af; padding: 0.4rem 0.3rem 0.7rem; }
    .muted { font-size: 0.75rem; color: #9ca3af; margin-top: 0.2rem; }

    .chip-row { display: flex; flex-wrap: wrap; gap: 0.35rem; }
    .chip {
      font-size: 0.7rem;
      padding: 0.15rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.96);
    }

    footer { padding: 0.7rem 1.4rem 1rem; font-size: 0.7rem; color: #6b7280; text-align: center; }
  </style>

  <!-- Librer√≠as -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <div>
      <h1><span class="logo">üîß</span>Panel de Ventas ‚Äì El Cedro</h1>
      <div class="subtitle">Carga tu CSV de ventas y analiza por sucursal, vendedor, categor√≠a y comparativos a√±o vs a√±o.</div>
    </div>
    <div style="font-size:0.8rem;">GitHub Pages listo</div>
  </header>

  <main>
    <!-- LATERAL: archivo + filtros -->
    <aside class="sidebar card">
      <h2><span class="icon">üìÇ</span>Archivo</h2>
      <div class="field">
        <label for="file-input">Archivo CSV</label>
        <input type="file" id="file-input" accept=".csv,text/csv" />
        <div class="hint">
          Exporta desde Excel/Sheets a <b>CSV</b> con columnas como: A√±o, Mes, Sucursal, Vendedor, Contado, Cr√©dito, Utilidad, etc.
        </div>
      </div>

      <hr />

      <h2><span class="icon">üéõÔ∏è</span>Filtros globales</h2>

      <div class="field">
        <label>Filtro 1</label>
        <div class="field-row">
          <select id="filter1-column"><option value="">Columna‚Ä¶</option></select>
          <select id="filter1-value"><option value="">Valor‚Ä¶</option></select>
        </div>
      </div>
      <div class="field">
        <label>Filtro 2</label>
        <div class="field-row">
          <select id="filter2-column"><option value="">Columna‚Ä¶</option></select>
          <select id="filter2-value"><option value="">Valor‚Ä¶</option></select>
        </div>
      </div>
      <div class="field">
        <label>Filtro 3</label>
        <div class="field-row">
          <select id="filter3-column"><option value="">Columna‚Ä¶</option></select>
          <select id="filter3-value"><option value="">Valor‚Ä¶</option></select>
        </div>
      </div>

      <div class="field">
        <label>M√©trica por rango (opcional)</label>
        <select id="range-metric-column"><option value="">M√©trica‚Ä¶</option></select>
        <div class="field-row" style="margin-top:0.25rem;">
          <input type="number" id="range-metric-min" placeholder="M√≠n" />
          <input type="number" id="range-metric-max" placeholder="M√°x" />
        </div>
        <div class="hint">Ejemplo: Utilidad &gt; 0, Venta &lt; 10000, Margen entre 20 y 40.</div>
      </div>

      <div class="field-row" style="margin-top:0.35rem;">
        <button id="apply-filters-btn">Aplicar filtros</button>
        <button id="clear-filters-btn" class="btn-secondary">Limpiar</button>
      </div>

      <hr />

      <h2><span class="icon">‚è±Ô∏è</span>A√±o y mes (para YoY)</h2>
      <div class="field">
        <label for="year-column-select">Columna A√±o</label>
        <select id="year-column-select"><option value="">Selecciona‚Ä¶</option></select>
      </div>
      <div class="field">
        <label for="month-column-select">Columna Mes</label>
        <select id="month-column-select"><option value="">Selecciona‚Ä¶</option></select>
        <div class="hint">Puede ser n√∫mero (1‚Äì12) o nombre (enero, febrero‚Ä¶).</div>
      </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <section class="content-area">
      <!-- Tabs -->
      <div class="card">
        <div class="tabs">
          <button class="tab-btn active" data-target="tab-general">An√°lisis general</button>
          <button class="tab-btn" data-target="tab-yoy">Comparativo A√±o vs A√±o</button>
        </div>

        <!-- KPIs -->
        <div class="kpi-grid">
          <div class="kpi">
            <div class="label">Registros</div>
            <div class="value" id="kpi-rows">‚Äì</div>
            <div class="sub">Filas despu√©s de aplicar filtros.</div>
          </div>
          <div class="kpi">
            <div class="label">Suma m√©trica seleccionada</div>
            <div class="value" id="kpi-metric-sum">‚Äì</div>
            <div class="sub" id="kpi-metric-sum-label">Elige una m√©trica abajo.</div>
          </div>
          <div class="kpi">
            <div class="label">Promedio m√©trica</div>
            <div class="value" id="kpi-metric-avg">‚Äì</div>
            <div class="sub">En base a los datos filtrados.</div>
          </div>
          <div class="kpi">
            <div class="label">Columnas</div>
            <div class="value" id="kpi-cols">‚Äì</div>
            <div class="sub" id="kpi-cols-detail">‚Äì</div>
          </div>
        </div>

        <div class="chip-row" id="kpi-tags" style="margin-top:0.45rem;">
          <span class="chip">Sin archivo cargado.</span>
        </div>
      </div>

      <!-- TAB 1: An√°lisis general -->
      <div id="tab-general" class="card">
        <h2><span class="icon">üìä</span>An√°lisis general (tipo tabla din√°mica)</h2>
        <div class="muted">
          1) Aplica filtros en el panel izquierdo.<br>
          2) Elige una columna para agrupar (Sucursal, Vendedor, Categor√≠a, Cliente, etc.) y una m√©trica num√©rica (Venta, Utilidad, Margen‚Ä¶).
        </div>

        <div class="flex-row" style="margin-top:0.6rem;">
          <div class="flex-col">
            <div class="field">
              <label for="group-by-select">Agrupar por</label>
              <select id="group-by-select"><option value="">Selecciona columna‚Ä¶</option></select>
            </div>
          </div>
          <div class="flex-col">
            <div class="field">
              <label for="metric-select">M√©trica num√©rica</label>
              <select id="metric-select"><option value="">Selecciona m√©trica‚Ä¶</option></select>
            </div>
          </div>
          <div class="flex-col">
            <div class="field">
              <label for="agg-type-select">Operaci√≥n</label>
              <select id="agg-type-select">
                <option value="sum">Suma</option>
                <option value="avg">Promedio</option>
                <option value="count">Conteo</option>
                <option value="max">M√°ximo</option>
                <option value="min">M√≠nimo</option>
              </select>
            </div>
          </div>
          <div class="flex-col" style="align-self:flex-end;">
            <button id="update-agg-btn">Actualizar an√°lisis</button>
          </div>
        </div>

        <div class="flex-row" style="margin-top:0.7rem;">
          <div class="flex-col">
            <div class="table-container" id="group-table-container">
              <div class="empty-state">Carga un archivo, aplica filtros y elige Agrupar por + M√©trica.</div>
            </div>
          </div>
          <div class="flex-col">
            <div style="height:260px;">
              <canvas id="group-chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB 2: YoY -->
      <div id="tab-yoy" class="card" style="display:none;">
        <h2><span class="icon">üìÖ</span>Comparativo A√±o vs A√±o (mismo mes)</h2>
        <div class="muted">
          Usa los filtros globales para quedarte s√≥lo con la sucursal/categor√≠a que quieras. Despu√©s:
          selecciona <b>mes</b>, <b>A√±o base</b>, <b>A√±o comparado</b>, <b>m√©trica</b> y, opcionalmente, c√≥mo quieres agrupar.
        </div>

        <div class="flex-row" style="margin-top:0.6rem;">
          <div class="flex-col">
            <div class="field">
              <label for="yoy-month-select">Mes</label>
              <select id="yoy-month-select"><option value="">Selecciona mes‚Ä¶</option></select>
            </div>
          </div>
          <div class="flex-col">
            <div class="field">
              <label for="yoy-year-base-select">A√±o base (A)</label>
              <select id="yoy-year-base-select"><option value="">A√±o‚Ä¶</option></select>
            </div>
          </div>
          <div class="flex-col">
            <div class="field">
              <label for="yoy-year-comp-select">A√±o comparado (B)</label>
              <select id="yoy-year-comp-select"><option value="">A√±o‚Ä¶</option></select>
            </div>
          </div>
        </div>

        <div class="flex-row" style="margin-top:0.4rem;">
          <div class="flex-col">
            <div class="field">
              <label for="yoy-metric-select">M√©trica</label>
              <select id="yoy-metric-select"><option value="">Selecciona m√©trica‚Ä¶</option></select>
            </div>
          </div>
          <div class="flex-col">
            <div class="field">
              <label for="yoy-group-select">Agrupar por (opcional)</label>
              <select id="yoy-group-select"><option value="">Sin agrupaci√≥n (Total)</option></select>
            </div>
          </div>
          <div class="flex-col" style="align-self:flex-end;">
            <button id="yoy-run-btn">Calcular comparativo</button>
          </div>
        </div>

        <div id="yoy-summary" class="muted" style="margin-top:0.4rem;"></div>

        <div class="flex-row" style="margin-top:0.7rem;">
          <div class="flex-col">
            <div class="table-container" id="yoy-table-container">
              <div class="empty-state">Configura A√±o/Mes y selecciona los a√±os + m√©trica para ver diferencia y %.</div>
            </div>
          </div>
          <div class="flex-col">
            <div style="height:260px;">
              <canvas id="yoy-chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Vista previa de datos -->
      <div class="card">
        <h2><span class="icon">üßæ</span>Vista previa de datos filtrados</h2>
        <div class="muted">S√≥lo las primeras filas para no saturar el navegador.</div>
        <div class="table-container" id="data-table-container" style="margin-top:0.4rem;">
          <div class="empty-state">Sin datos. Carga un CSV para comenzar.</div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    Panel hecho para Ferreter√≠a El Cedro ‚Äì an√°lisis detallado de ventas y comparativos a√±o vs a√±o.
  </footer>

  <script>
    // ------------------------ Estado global ------------------------
    let rawData = [];
    let filteredData = [];
    let columns = [];
    let numericColumns = [];
    let groupChartInstance = null;
    let yoyChartInstance = null;

    // ---- DOM ----
    const fileInput = document.getElementById('file-input');

    const filter1Column = document.getElementById('filter1-column');
    const filter1Value  = document.getElementById('filter1-value');
    const filter2Column = document.getElementById('filter2-column');
    const filter2Value  = document.getElementById('filter2-value');
    const filter3Column = document.getElementById('filter3-column');
    const filter3Value  = document.getElementById('filter3-value');

    const rangeMetricColumn = document.getElementById('range-metric-column');
    const rangeMetricMin    = document.getElementById('range-metric-min');
    const rangeMetricMax    = document.getElementById('range-metric-max');

    const applyFiltersBtn = document.getElementById('apply-filters-btn');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');

    const yearColumnSelect  = document.getElementById('year-column-select');
    const monthColumnSelect = document.getElementById('month-column-select');

    const kpiRowsEl       = document.getElementById('kpi-rows');
    const kpiMetricSumEl  = document.getElementById('kpi-metric-sum');
    const kpiMetricSumLbl = document.getElementById('kpi-metric-sum-label');
    const kpiMetricAvgEl  = document.getElementById('kpi-metric-avg');
    const kpiColsEl       = document.getElementById('kpi-cols');
    const kpiColsDetailEl = document.getElementById('kpi-cols-detail');
    const kpiTagsEl       = document.getElementById('kpi-tags');

    const groupBySelect = document.getElementById('group-by-select');
    const metricSelect  = document.getElementById('metric-select');
    const aggTypeSelect = document.getElementById('agg-type-select');
    const updateAggBtn  = document.getElementById('update-agg-btn');
    const groupTableContainer = document.getElementById('group-table-container');
    const groupChartCanvas    = document.getElementById('group-chart');

    const dataTableContainer = document.getElementById('data-table-container');

    // YoY
    const yoyMonthSelect     = document.getElementById('yoy-month-select');
    const yoyYearBaseSelect  = document.getElementById('yoy-year-base-select');
    const yoyYearCompSelect  = document.getElementById('yoy-year-comp-select');
    const yoyMetricSelect    = document.getElementById('yoy-metric-select');
    const yoyGroupSelect     = document.getElementById('yoy-group-select');
    const yoyRunBtn          = document.getElementById('yoy-run-btn');
    const yoyTableContainer  = document.getElementById('yoy-table-container');
    const yoyChartCanvas     = document.getElementById('yoy-chart');
    const yoySummaryEl       = document.getElementById('yoy-summary');

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.dataset.target;
        document.getElementById('tab-general').style.display = target === 'tab-general' ? '' : 'none';
        document.getElementById('tab-yoy').style.display     = target === 'tab-yoy' ? '' : 'none';
      });
    });

    // ------------------------ Utilidades ------------------------
    function normalizeNumber(v) {
      if (v === null || v === undefined) return NaN;
      if (typeof v === 'number') return v;
      let s = String(v).trim();
      if (!s) return NaN;
      s = s.replace(/[$%]/g, '').replace(/\s/g,'');
      const commas = (s.match(/,/g) || []).length;
      const dots   = (s.match(/\./g) || []).length;
      if (commas === 1 && dots === 0) s = s.replace(',', '.');
      s = s.replace(/,/g,'');
      const n = parseFloat(s);
      return isNaN(n) ? NaN : n;
    }

    function formatNumber(n) {
      if (n === null || n === undefined || isNaN(n)) return '‚Äì';
      return n.toLocaleString('es-MX',{ maximumFractionDigits:2 });
    }

    function createOption(value,label) {
      const o = document.createElement('option');
      o.value = value;
      o.textContent = label;
      return o;
    }

    function uniqueValues(data, col) {
      const set = new Set();
      data.forEach(r => set.add(r[col]));
      return Array.from(set).filter(v => v !== null && v !== undefined && v !== '');
    }

    function detectNumericColumns(data) {
      if (!data.length) return [];
      const cols = Object.keys(data[0]);
      const numeric = [];
      cols.forEach(col => {
        let samples = 0, numericSamples = 0;
        for (let i=0;i<data.length && samples<60;i++) {
          const v = data[i][col];
          if (v === '' || v === null || v === undefined) continue;
          samples++;
          if (!isNaN(normalizeNumber(v))) numericSamples++;
        }
        if (samples>0 && numericSamples/samples >= 0.6) numeric.push(col);
      });
      return numeric;
    }

    function resetSelect(sel, firstLabel) {
      while (sel.firstChild) sel.removeChild(sel.firstChild);
      if (firstLabel !== null) sel.appendChild(createOption('', firstLabel));
    }

    // ------------------------ Carga CSV ------------------------
    fileInput.addEventListener('change', e => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      Papa.parse(file,{
        header:true,
        dynamicTyping:false,
        skipEmptyLines:true,
        complete: res => {
          rawData = res.data || [];
          filteredData = [...rawData];
          columns = rawData.length ? Object.keys(rawData[0]) : [];
          numericColumns = detectNumericColumns(rawData);
          rellenarUI();
          actualizarKPIs();
          renderDataTable();
          renderGeneral();
          actualizarYoYConfig();

          kpiTagsEl.innerHTML = '';
          kpiTagsEl.appendChild(createOptionTag('Archivo: '+file.name));
          kpiTagsEl.appendChild(createOptionTag(numericColumns.length+' columnas num√©ricas'));
        },
        error: err => alert('Error leyendo CSV: '+err.message)
      });
    });

    function createOptionTag(text){
      const span = document.createElement('span');
      span.className = 'chip';
      span.textContent = text;
      return span;
    }

    // ------------------------ Rellenar selects ------------------------
    function rellenarUI() {
      // Filtros
      [filter1Column,filter2Column,filter3Column].forEach(sel=>{
        resetSelect(sel,'Columna‚Ä¶');
        columns.forEach(c=>sel.appendChild(createOption(c,c)));
      });
      [filter1Value,filter2Value,filter3Value].forEach(sel=>{
        resetSelect(sel,'Valor‚Ä¶');
      });

      // Rango m√©trico
      resetSelect(rangeMetricColumn,'M√©trica‚Ä¶');
      numericColumns.forEach(c=>rangeMetricColumn.appendChild(createOption(c,c)));

      // Agrupaci√≥n general
      resetSelect(groupBySelect,'Selecciona columna‚Ä¶');
      columns.forEach(c=>groupBySelect.appendChild(createOption(c,c)));
      resetSelect(metricSelect,'Selecciona m√©trica‚Ä¶');
      numericColumns.forEach(c=>metricSelect.appendChild(createOption(c,c)));

      // A√±o / Mes
      resetSelect(yearColumnSelect,'Selecciona‚Ä¶');
      resetSelect(monthColumnSelect,'Selecciona‚Ä¶');
      columns.forEach(c=>{
        yearColumnSelect.appendChild(createOption(c,c));
        monthColumnSelect.appendChild(createOption(c,c));
      });

      // YoY
      resetSelect(yoyMetricSelect,'Selecciona m√©trica‚Ä¶');
      numericColumns.forEach(c=>yoyMetricSelect.appendChild(createOption(c,c)));
      resetSelect(yoyGroupSelect,null);
      yoyGroupSelect.appendChild(createOption('','Sin agrupaci√≥n (Total)'));
      columns.forEach(c=>yoyGroupSelect.appendChild(createOption(c,c)));

      // Preselecciones t√≠picas
      const lower = columns.map(c=>c.toLowerCase());
      const lowerNum = numericColumns.map(c=>c.toLowerCase());

      const gCandidates = ['sucursal','vendedor','categoria','categor√≠a','cliente'];
      const mCandidates = ['venta total','ventas','monto','utilidad','margen','contado','cr√©dito','credito'];
      const yCandidates = ['a√±o','anio','year'];
      const moCandidates = ['mes'];

      groupBySelect.value = findMatch(columns,lower,gCandidates) || '';
      metricSelect.value  = findMatch(numericColumns,lowerNum,mCandidates) || '';
      yoyMetricSelect.value = metricSelect.value || '';

      yearColumnSelect.value  = findMatch(columns,lower,yCandidates) || '';
      monthColumnSelect.value = findMatch(columns,lower,moCandidates) || '';

      actualizarYoYConfig();
    }

    function findMatch(original,lower,keys){
      for (const key of keys){
        const idx = lower.indexOf(key);
        if (idx>=0) return original[idx];
      }
      return '';
    }

    // Filtros: cuando elijo columna, lleno valores posibles
    filter1Column.addEventListener('change',()=>fillFilterValues(filter1Column,filter1Value));
    filter2Column.addEventListener('change',()=>fillFilterValues(filter2Column,filter2Value));
    filter3Column.addEventListener('change',()=>fillFilterValues(filter3Column,filter3Value));

    function fillFilterValues(colSelect,valSelect){
      const col = colSelect.value;
      resetSelect(valSelect,'Valor‚Ä¶');
      if (!col || !rawData.length) return;
      const vals = uniqueValues(rawData,col).sort();
      valSelect.appendChild(createOption('','Todos'));
      vals.forEach(v=>valSelect.appendChild(createOption(v,v)));
    }

    // ------------------------ Aplicar / limpiar filtros ------------------------
    applyFiltersBtn.addEventListener('click',()=>{
      aplicarFiltros();
      actualizarKPIs();
      renderDataTable();
      renderGeneral();
      actualizarYoYConfig();
    });

    clearFiltersBtn.addEventListener('click',()=>{
      [filter1Column,filter2Column,filter3Column].forEach(sel=>sel.value='');
      [filter1Value,filter2Value,filter3Value].forEach(sel=>resetSelect(sel,'Valor‚Ä¶'));
      rangeMetricColumn.value='';
      rangeMetricMin.value='';
      rangeMetricMax.value='';
      filteredData = [...rawData];
      actualizarKPIs();
      renderDataTable();
      renderGeneral();
      actualizarYoYConfig();
    });

    function aplicarFiltros(){
      if (!rawData.length) return;
      let data = [...rawData];

      [[filter1Column,filter1Value],[filter2Column,filter2Value],[filter3Column,filter3Value]].forEach(([cSel,vSel])=>{
        const col = cSel.value;
        const val = vSel.value;
        if (col && val) data = data.filter(r=>String(r[col])===String(val));
      });

      const colRange = rangeMetricColumn.value;
      const minStr = rangeMetricMin.value;
      const maxStr = rangeMetricMax.value;
      const hasMin = minStr !== '';
      const hasMax = maxStr !== '';

      if (colRange && (hasMin || hasMax)) {
        const minVal = hasMin ? parseFloat(minStr) : null;
        const maxVal = hasMax ? parseFloat(maxStr) : null;
        data = data.filter(r=>{
          const n = normalizeNumber(r[colRange]);
          if (isNaN(n)) return false;
          if (minVal!==null && n<minVal) return false;
          if (maxVal!==null && n>maxVal) return false;
          return true;
        });
      }
      filteredData = data;
    }

    // ------------------------ KPIs ------------------------
    function actualizarKPIs(){
      kpiRowsEl.textContent = filteredData.length ? formatNumber(filteredData.length) : '‚Äì';
      kpiColsEl.textContent = columns.length ? columns.length : '‚Äì';
      kpiColsDetailEl.textContent = columns.length ? columns.slice(0,5).join(', ')+(columns.length>5?'‚Ä¶':'') : '‚Äì';

      const metric = metricSelect.value;
      if (!metric || !numericColumns.includes(metric)) {
        kpiMetricSumEl.textContent = '‚Äì';
        kpiMetricAvgEl.textContent = '‚Äì';
        kpiMetricSumLbl.textContent = 'Elige una m√©trica num√©rica.';
        return;
      }

      let sum=0,count=0;
      filteredData.forEach(r=>{
        const n = normalizeNumber(r[metric]);
        if (!isNaN(n)){ sum+=n; count++; }
      });
      const avg = count ? sum/count : NaN;
      kpiMetricSumEl.textContent = formatNumber(sum);
      kpiMetricAvgEl.textContent = formatNumber(avg);
      kpiMetricSumLbl.textContent = 'Suma total de "'+metric+'".';
    }

    // ------------------------ An√°lisis general ------------------------
    updateAggBtn.addEventListener('click',()=>{
      actualizarKPIs();
      renderGeneral();
    });

    function agruparDatos(data, groupCol, metricCol, aggType){
      const groups = {};
      data.forEach(r=>{
        const rawKey = r[groupCol];
        const key = (rawKey===null || rawKey===undefined || rawKey==='') ? '(Sin valor)' : String(rawKey);
        if (!groups[key]) groups[key] = { count:0, sum:0, max:null, min:null };
        groups[key].count++;
        const n = normalizeNumber(r[metricCol]);
        if (!isNaN(n)){
          groups[key].sum += n;
          if (groups[key].max===null || n>groups[key].max) groups[key].max=n;
          if (groups[key].min===null || n<groups[key].min) groups[key].min=n;
        }
      });

      const result = [];
      for (const k in groups){
        const g = groups[k];
        let value;
        switch(aggType){
          case 'avg':  value = g.count ? g.sum/g.count : NaN; break;
          case 'count':value = g.count; break;
          case 'max':  value = g.max; break;
          case 'min':  value = g.min; break;
          default:     value = g.sum;
        }
        result.push({ group:k, value, sum:g.sum, count:g.count });
      }
      result.sort((a,b)=>(isNaN(b.value)?-1:b.value) - (isNaN(a.value)?-1:a.value));
      return result;
    }

    function renderGeneral(){
      groupTableContainer.innerHTML = '';
      if (!filteredData.length){
        groupTableContainer.innerHTML = '<div class="empty-state">No hay datos despu√©s de filtros.</div>';
        if (groupChartInstance){groupChartInstance.destroy();groupChartInstance=null;}
        return;
      }
      const groupCol = groupBySelect.value;
      const metricCol = metricSelect.value;
      const aggType  = aggTypeSelect.value;

      if (!groupCol || !metricCol){
        groupTableContainer.innerHTML = '<div class="empty-state">Selecciona Agrupar por y una M√©trica.</div>';
        if (groupChartInstance){groupChartInstance.destroy();groupChartInstance=null;}
        return;
      }

      const grouped = agruparDatos(filteredData,groupCol,metricCol,aggType);
      const top = grouped.slice(0,15);

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const trHead = document.createElement('tr');
      ['Grupo ('+groupCol+')','Valor ('+aggType+')','Suma','Conteo'].forEach(h=>{
        const th = document.createElement('th');
        th.textContent = h;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      top.forEach(r=>{
        const tr = document.createElement('tr');
        ['group','value','sum','count'].forEach(key=>{
          const td = document.createElement('td');
          td.textContent = key==='group' ? r[key] : formatNumber(r[key]);
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      groupTableContainer.appendChild(table);

      const labels = top.map(r=>r.group);
      const values = top.map(r=>isNaN(r.value)?0:r.value);

      if (groupChartInstance){groupChartInstance.destroy();}
      groupChartInstance = new Chart(groupChartCanvas,{
        type:'bar',
        data:{ labels, datasets:[{ label: metricCol+' ('+aggType+')', data:values }] },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            x:{ticks:{color:'#e5e7eb',maxRotation:45,minRotation:0},grid:{display:false}},
            y:{ticks:{color:'#e5e7eb'},grid:{color:'rgba(148,163,184,0.3)'}}
          },
          plugins:{
            legend:{labels:{color:'#e5e7eb'}},
            tooltip:{callbacks:{label:ctx=>' '+formatNumber(ctx.raw)}}
          }
        }
      });
    }

    // ------------------------ Vista previa datos ------------------------
    function renderDataTable(){
      dataTableContainer.innerHTML = '';
      if (!filteredData.length){
        dataTableContainer.innerHTML = '<div class="empty-state">No hay datos. Revisa filtros o carga un archivo.</div>';
        return;
      }
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const trHead = document.createElement('tr');
      columns.forEach(c=>{
        const th = document.createElement('th');
        th.textContent = c;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      const maxRows = 80;
      filteredData.slice(0,maxRows).forEach(row=>{
        const tr = document.createElement('tr');
        columns.forEach(c=>{
          const td = document.createElement('td');
          td.textContent = row[c];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      dataTableContainer.appendChild(table);

      if (filteredData.length>maxRows){
        const note = document.createElement('div');
        note.className = 'muted';
        note.textContent = 'Mostrando primeras '+maxRows+' filas de '+filteredData.length+'.';
        dataTableContainer.appendChild(note);
      }
    }

    // ------------------------ Config YoY ------------------------
    yearColumnSelect.addEventListener('change',actualizarYoYConfig);
    monthColumnSelect.addEventListener('change',actualizarYoYConfig);

    function actualizarYoYConfig(){
      resetSelect(yoyMonthSelect,'Selecciona mes‚Ä¶');
      resetSelect(yoyYearBaseSelect,'A√±o‚Ä¶');
      resetSelect(yoyYearCompSelect,'A√±o‚Ä¶');

      const yCol = yearColumnSelect.value;
      const mCol = monthColumnSelect.value;
      if (!filteredData.length || !yCol || !mCol) return;

      const meses = uniqueValues(filteredData,mCol).sort();
      meses.forEach(m=>yoyMonthSelect.appendChild(createOption(m,m)));

      const years = uniqueValues(filteredData,yCol).sort();
      years.forEach(y=>{
        yoyYearBaseSelect.appendChild(createOption(y,y));
        yoyYearCompSelect.appendChild(createOption(y,y));
      });
    }

    yoyRunBtn.addEventListener('click',()=>calcularYoY());

    function calcularYoY(){
      yoyTableContainer.innerHTML = '';
      yoySummaryEl.textContent = '';

      const yCol = yearColumnSelect.value;
      const mCol = monthColumnSelect.value;
      const monthVal = yoyMonthSelect.value;
      const yearA = yoyYearBaseSelect.value;
      const yearB = yoyYearCompSelect.value;
      const metricCol = yoyMetricSelect.value;
      const groupCol  = yoyGroupSelect.value;

      if (!filteredData.length){
        yoyTableContainer.innerHTML = '<div class="empty-state">No hay datos despu√©s de filtros.</div>';
        if (yoyChartInstance){yoyChartInstance.destroy();yoyChartInstance=null;}
        return;
      }
      if (!yCol || !mCol){
        yoyTableContainer.innerHTML = '<div class="empty-state">Primero selecciona columna A√±o y columna Mes.</div>';
        if (yoyChartInstance){yoyChartInstance.destroy();yoyChartInstance=null;}
        return;
      }
      if (!monthVal || !yearA || !yearB || !metricCol){
        yoyTableContainer.innerHTML = '<div class="empty-state">Selecciona mes, A√±o A, A√±o B y m√©trica.</div>';
        if (yoyChartInstance){yoyChartInstance.destroy();yoyChartInstance=null;}
        return;
      }
      if (!numericColumns.includes(metricCol)){
        yoyTableContainer.innerHTML = '<div class="empty-state">La m√©trica seleccionada no es num√©rica.</div>';
        if (yoyChartInstance){yoyChartInstance.destroy();yoyChartInstance=null;}
        return;
      }

      const dataMes = filteredData.filter(r =>
        String(r[mCol])===String(monthVal) &&
        (String(r[yCol])===String(yearA) || String(r[yCol])===String(yearB))
      );
      if (!dataMes.length){
        yoyTableContainer.innerHTML = '<div class="empty-state">No hay datos para ese mes y a√±os seleccionados.</div>';
        if (yoyChartInstance){yoyChartInstance.destroy();yoyChartInstance=null;}
        return;
      }

      const groups = {};
      dataMes.forEach(r=>{
        const year = String(r[yCol]);
        const gKey = groupCol ? (r[groupCol] ?? '(Sin valor)') : 'TOTAL';
        if (!groups[gKey]) groups[gKey] = { sumA:0, sumB:0 };
        const n = normalizeNumber(r[metricCol]);
        if (isNaN(n)) return;
        if (year===String(yearA)) groups[gKey].sumA += n;
        if (year===String(yearB)) groups[gKey].sumB += n;
      });

      const rows=[];
      for (const g in groups){
        const sA = groups[g].sumA;
        const sB = groups[g].sumB;
        const diff = sB - sA;
        const pct  = sA===0 ? (sB===0 ? NaN : Infinity) : (diff/sA)*100;
        rows.push({ group:g, sumA:sA, sumB:sB, diff, pct });
      }
      if (!rows.length){
        yoyTableContainer.innerHTML = '<div class="empty-state">No hay datos num√©ricos v√°lidos para esa combinaci√≥n.</div>';
        if (yoyChartInstance){yoyChartInstance.destroy();yoyChartInstance=null;}
        return;
      }
      rows.sort((a,b)=>b.sumB - a.sumB);

      // Totales
      let tA=0,tB=0;
      rows.forEach(r=>{ tA+=r.sumA; tB+=r.sumB; });
      const tDiff = tB - tA;
      const tPct = tA===0 ? (tB===0 ? NaN : Infinity) : (tDiff/tA)*100;

      const pctText = isNaN(tPct) ? '‚Äì' : (!isFinite(tPct) ? '‚àû' : tPct.toFixed(1)+' %');
      yoySummaryEl.textContent =
        monthVal+' '+yearA+': '+formatNumber(tA)+' | '+
        monthVal+' '+yearB+': '+formatNumber(tB)+' | Dif: '+formatNumber(tDiff)+' | Var %: '+pctText;

      // Tabla
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');
      const trHead = document.createElement('tr');
      [groupCol ? 'Grupo ('+groupCol+')':'Total', metricCol+' '+yearA, metricCol+' '+yearB, 'Diferencia', 'Var %'].forEach(h=>{
        const th = document.createElement('th'); th.textContent = h; trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const pct = isNaN(r.pct) ? '‚Äì' : (!isFinite(r.pct) ? '‚àû' : r.pct.toFixed(1)+' %');
        [r.group, formatNumber(r.sumA), formatNumber(r.sumB), formatNumber(r.diff), pct].forEach(val=>{
          const td = document.createElement('td'); td.textContent = val; tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(thead); table.appendChild(tbody);
      yoyTableContainer.appendChild(table);

      // Gr√°fica
      const labels = rows.map(r=>r.group);
      const dataA  = rows.map(r=>r.sumA);
      const dataB  = rows.map(r=>r.sumB);

      if (yoyChartInstance){yoyChartInstance.destroy();}
      yoyChartInstance = new Chart(yoyChartCanvas,{
        type:'bar',
        data:{
          labels,
          datasets:[
            { label: yearA, data:dataA },
            { label: yearB, data:dataB }
          ]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{
            x:{ticks:{color:'#e5e7eb',maxRotation:45,minRotation:0},grid:{display:false}},
            y:{ticks:{color:'#e5e7eb'},grid:{color:'rgba(148,163,184,0.3)'}}
          },
          plugins:{
            legend:{labels:{color:'#e5e7eb'}},
            tooltip:{callbacks:{label:ctx=>' '+formatNumber(ctx.raw)}}
          }
        }
      });
    }
  </script>
</body>
</html>
