<script>
  // --------- Utilidades ---------
  function normalizarNombre(str) {
    return String(str)
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, "")
      .replace(/_/g, "");
  }

  function encontrarColumna(headers, aliases) {
    const normHeaders = headers.map(h => normalizarNombre(h));
    for (const alias of aliases) {
      const normAlias = normalizarNombre(alias);
      const idx = normHeaders.indexOf(normAlias);
      if (idx >= 0) return headers[idx];
    }
    return null;
  }

  function extraerFecha(raw) {
    if (!raw) return null;
    const s = String(raw).trim();

    let m = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
    if (m) return { year:+m[1], month:+m[2] };

    m = s.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
    if (m) return { year:+m[3], month:+m[2] };

    const d = new Date(s);
    if (!isNaN(d)) return { year:d.getFullYear(), month:d.getMonth()+1 };
    return null;
  }

  const MESES = ["","enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];

  document.getElementById('file-input').addEventListener('change', function (e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    document.getElementById('status').textContent = 'Leyendo archivo...';

    Papa.parse(file, {
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: function (results) {
        let data = results.data || [];

        if (!data.length) {
          document.getElementById('status').textContent = 'Archivo vacío.';
          return;
        }

        // ✅ LIMPIEZA CRÍTICA DE ENCABEZADOS
        const cleaned = data.map(row => {
          const newRow = {};
          Object.keys(row).forEach(k => {
            const cleanKey = k.trim();   // <- elimina espacios invisibles
            newRow[cleanKey] = row[k];
          });
          return newRow;
        });

        const headers = Object.keys(cleaned[0]);

        const fechaCol = encontrarColumna(headers, ['fecha']);
        const totalCol = encontrarColumna(headers, ['totalfac','total_fac','total']);
        const sucCol   = encontrarColumna(headers, ['cvesuc','cve_suc']);
        const vendedorCol = encontrarColumna(headers, ['vendedor']);
        const categoriaCol = encontrarColumna(headers, ['categoria']);

        document.getElementById('status').textContent =
          'Archivo cargado correctamente: ' + file.name + ' (' + cleaned.length + ' filas).';

        crearPivotSeguro(cleaned, fechaCol, totalCol, sucCol, vendedorCol, categoriaCol);
      },
      error: function (err) {
        document.getElementById('status').textContent = 'Error al leer CSV: ' + err.message;
      }
    });
  });

  function crearPivotSeguro(data, fechaCol, totalCol, sucCol, vendedorCol, categoriaCol) {
    const renderers = $.extend(
      $.pivotUtilities.renderers,
      $.pivotUtilities.plotly_renderers
    );

    const derived = {};

    if (fechaCol) {
      derived["Año"] = r => {
        const f = extraerFecha(r[fechaCol]);
        return f ? f.year : "";
      };
      derived["Mes"] = r => {
        const f = extraerFecha(r[fechaCol]);
        return f ? f.month : "";
      };
      derived["Mes Nombre"] = r => {
        const f = extraerFecha(r[fechaCol]);
        return f ? MESES[f.month] : "";
      };
    }

    const rows = sucCol ? [sucCol] : [];
    const cols = fechaCol ? ["Año"] : [];
    const vals = totalCol ? [totalCol] : [];

    $("#output").empty().pivotUI(
      data,
      {
        derivedAttributes: derived,
        rows: rows,
        cols: cols,
        vals: vals,
        aggregatorName: totalCol ? "Sum" : "Count",
        rendererName: "Table",
        renderers: renderers
      },
      true
    );
  }
</script>
