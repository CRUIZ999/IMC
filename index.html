<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Analizador de Ventas ‚Äì Tabla Din√°mica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { background: #0f172a; color: #e5e7eb; min-height: 100vh; padding: 1rem; }
    h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
    .sub { font-size: 0.8rem; margin-bottom: 0.8rem; color: #cbd5f5; }

    .panel {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 1rem;
    }
    @media (max-width: 900px){ .panel{ grid-template-columns: 1fr; } }

    .card {
      background: #020617;
      border-radius: 0.8rem;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 0.8rem;
    }
    label { font-size: 0.8rem; margin-bottom: 0.25rem; display: block; }
    input[type="file"], select, button {
      width: 100%;
      padding: 0.4rem;
      border-radius: 0.4rem;
      border: 1px solid rgba(148,163,184,0.6);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
    }
    button {
      cursor: pointer;
      font-weight: 600;
      background: linear-gradient(135deg, #fb923c, #f97316);
      color: #111827;
      border: none;
      box-shadow: 0 8px 20px rgba(249,115,22,0.5);
    }
    button:hover { opacity: 0.95; }
    .hint { font-size: 0.75rem; color: #9ca3af; margin-top: 0.3rem; line-height: 1.3; }
    #status { font-size: 0.8rem; margin-top: 0.4rem; }

    #pivot-output, #yoy-table, #kpi-table {
      background: #020617;
      border-radius: 0.8rem;
      border: 1px solid rgba(148,163,184,0.4);
      padding: 0.4rem;
      min-height: 80px;
      overflow: auto;
    }

    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.6rem;
    }
    .tab-btn {
      flex: 1;
      padding: 0.35rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
      text-align: center;
    }
    .tab-btn.active {
      background: #f97316;
      color: #111827;
      border-color: #f97316;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .flex-row { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem; }
    .flex-col { flex: 1 1 160px; }

    .kpis { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem; }
    .kpi {
      flex: 1 1 160px;
      padding: 0.4rem 0.5rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(148,163,184,0.5);
      background: radial-gradient(circle at top, rgba(148,163,184,0.25), rgba(15,23,42,0.98));
    }
    .kpi-label { font-size: 0.7rem; color: #9ca3af; text-transform: uppercase; letter-spacing: .08em; }
    .kpi-value { font-size: 1rem; font-weight: 800; }

    .pvtUi, .pvtTable { font-size: 0.75rem; }

    table.yoy, table.kpi {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }
    table.yoy th, table.yoy td,
    table.kpi th, table.kpi td {
      border-bottom: 1px solid rgba(75,85,99,0.9);
      padding: 0.25rem 0.35rem;
      text-align: right;
      white-space: nowrap;
    }
    table.yoy th:first-child, table.yoy td:first-child,
    table.kpi th:first-child, table.kpi td:first-child { text-align: left; }
    table.yoy th, table.kpi th { background: #020617; position: sticky; top: 0; }
    table.yoy tr:nth-child(even),
    table.kpi tr:nth-child(even){ background: rgba(15,23,42,0.7); }

    #yoy-chart { height: 260px; }
  </style>

  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.css" />

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-2.31.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/plotly_renderers.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>Analizador de Ventas</h1>
  <div class="sub">
    Sube tu archivo de ventas (facturas) y arma tablas din√°micas, comparativos A√±o vs A√±o y KPIs detallados por almac√©n.
  </div>

  <div class="panel">
    <!-- Lado izquierdo -->
    <div class="card">
      <label for="file-input">Archivo CSV de ventas</label>
      <input type="file" id="file-input" accept=".csv,text/csv" />
      <div class="hint">
        Columnas esperadas (o similares):<br>
        factura, fecha, estatus, descuento, subt_fac, total_fac, iva, id cliente,
        id clase, clave, cant_surt, cve_mon, unidad, cve_suc, id vendedor, cliente,
        producto, cantidad pz, almacen, hora, costoprom2, marca, costo1, vendedor,
        filtro1, filtro2, filtro3, Tipo de Factura, costo2, utilidad, margen, categoria.
      </div>
      <div id="status">Sin archivo cargado.</div>

      <div class="hint" style="margin-top:0.8rem;">
        üëâ <b>Exploraci√≥n libre</b>: tabla din√°mica tipo Excel (tab ‚ÄúExploraci√≥n libre‚Äù).<br>
        üëâ <b>A√±o vs A√±o</b>: comparativo por sucursal/vendedor/categor√≠a (tab ‚ÄúComparativo A√±o vs A√±o‚Äù).<br>
        üëâ <b>KPIs</b>: tablero como tu Excel, con filtro por almac√©n y KPIs por m¬≤ (tab ‚ÄúKPIs Ventas‚Äù).
      </div>
    </div>

    <!-- Lado derecho -->
    <div class="card">
      <div class="tabs">
        <button class="tab-btn active" data-tab="pivot-tab">Exploraci√≥n libre</button>
        <button class="tab-btn" data-tab="yoy-tab">Comparativo A√±o vs A√±o</button>
        <button class="tab-btn" data-tab="kpi-tab">KPIs Ventas</button>
      </div>

      <!-- KPIs YoY (para tab YoY) -->
      <div id="yoy-kpis" class="kpis" style="display:none;">
        <div class="kpi">
          <div class="kpi-label">Total A√±o A</div>
          <div class="kpi-value" id="yoy-total-a">‚Äì</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Total A√±o B</div>
          <div class="kpi-value" id="yoy-total-b">‚Äì</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Diferencia</div>
          <div class="kpi-value" id="yoy-diff">‚Äì</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">% Variaci√≥n</div>
          <div class="kpi-value" id="yoy-pct">‚Äì</div>
        </div>
      </div>

      <!-- TAB 1: EXPLORACI√ìN LIBRE -->
      <div id="pivot-tab" class="tab-content active">
        <!-- Filtros globales -->
        <div class="flex-row">
          <div class="flex-col">
            <label for="pivot-year">A√±o</label>
            <select id="pivot-year"></select>
          </div>
          <div class="flex-col">
            <label for="pivot-month">Mes</label>
            <select id="pivot-month"></select>
          </div>
          <div class="flex-col">
            <label for="pivot-store">Almac√©n</label>
            <select id="pivot-store"></select>
          </div>
        </div>

        <!-- Dise√±os r√°pidos / subniveles -->
        <div class="flex-row">
          <div class="flex-col">
            <label for="pivot-layout">Dise√±o r√°pido</label>
            <select id="pivot-layout"></select>
          </div>
          <div class="flex-col">
            <label for="pivot-agg">Indicador principal</label>
            <select id="pivot-agg"></select>
          </div>
          <div class="flex-col" style="align-self:flex-end;">
            <button id="pivot-apply">Aplicar dise√±o</button>
          </div>
        </div>

        <div id="pivot-output">
          <div class="hint">
            Aqu√≠ puedes arrastrar m√°s campos a ‚ÄúRows / Filas‚Äù para agregar subniveles
            (por ejemplo: Sucursal &gt; Categor√≠a &gt; Producto).
          </div>
        </div>
      </div>

      <!-- TAB 2: COMPARATIVO A√ëO VS A√ëO -->
      <div id="yoy-tab" class="tab-content">
        <div class="flex-row">
          <div class="flex-col">
            <label for="yoy-year-a">A√±o A (base)</label>
            <select id="yoy-year-a"></select>
          </div>
          <div class="flex-col">
            <label for="yoy-year-b">A√±o B (comparado)</label>
            <select id="yoy-year-b"></select>
          </div>
          <div class="flex-col">
            <label for="yoy-month">Mes</label>
            <select id="yoy-month"></select>
          </div>
        </div>

        <div class="flex-row">
          <div class="flex-col">
            <label for="yoy-metric">M√©trica</label>
            <select id="yoy-metric"></select>
          </div>
          <div class="flex-col">
            <label for="yoy-group">Agrupar por</label>
            <select id="yoy-group"></select>
          </div>
          <div class="flex-col" style="align-self:flex-end;">
            <button id="yoy-run">Calcular comparativo</button>
          </div>
        </div>

        <div class="hint" id="yoy-summary" style="margin-bottom:0.4rem;">
          Selecciona A√±o A, A√±o B, Mes y M√©trica y luego haz clic en <b>Calcular comparativo</b>.
        </div>

        <div style="display:flex; flex-wrap:wrap; gap:0.6rem;">
          <div style="flex:1 1 260px; min-width:0;">
            <div id="yoy-table"></div>
          </div>
          <div style="flex:1 1 260px; min-width:0;">
            <div id="yoy-chart"></div>
          </div>
        </div>
      </div>

      <!-- TAB 3: KPIs tipo Excel -->
      <div id="kpi-tab" class="tab-content">
        <div class="flex-row">
          <div class="flex-col">
            <label for="kpi-year-a-select">A√±o A (por ejemplo 2024)</label>
            <select id="kpi-year-a-select"></select>
          </div>
          <div class="flex-col">
            <label for="kpi-year-b-select">A√±o B (por ejemplo 2025)</label>
            <select id="kpi-year-b-select"></select>
          </div>
          <div class="flex-col">
            <label for="kpi-month">Mes</label>
            <select id="kpi-month"></select>
          </div>
          <div class="flex-col">
            <label for="kpi-store">Almac√©n</label>
            <select id="kpi-store"></select>
          </div>
          <div class="flex-col" style="align-self:flex-end;">
            <button id="kpi-run">Calcular KPIs</button>
          </div>
        </div>

        <div class="hint" id="kpi-summary" style="margin-bottom:0.4rem;">
          Elige a√±os, mes (o ‚ÄúTodos los meses‚Äù) y almac√©n (o ‚ÄúTodos‚Äù) y presiona <b>Calcular KPIs</b>.
        </div>

        <div id="kpi-table"></div>
      </div>
    </div>
  </div>

  <script>
    function normalizarNombre(str) {
      return String(str)
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\s+/g, "")
        .replace(/_/g, "");
    }

    function encontrarColumna(headers, posibles) {
      const normHeaders = headers.map(h => normalizarNombre(h));
      for (const alias of posibles) {
        const na = normalizarNombre(alias);
        const idx = normHeaders.indexOf(na);
        if (idx >= 0) return headers[idx];
      }
      return null;
    }

    function parseFecha(raw) {
      if (!raw) return null;
      const sFull = String(raw).trim();
      const s = sFull.split(" ")[0];
      let m = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
      if (m) return { year: +m[1], month: +m[2] };
      m = s.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
      if (m) return { year: +m[3], month: +m[2] };
      const d = new Date(sFull);
      if (!isNaN(d)) return { year: d.getFullYear(), month: d.getMonth() + 1 };
      return null;
    }

    const MESES = ["","enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"];

    function formatNumber(n, decimals=2) {
      if (n === null || n === undefined || isNaN(n)) return "‚Äì";
      return n.toLocaleString("es-MX", { maximumFractionDigits: decimals, minimumFractionDigits: 0 });
    }

    let rawData = [];
    let meta = {
      fechaCol: null,
      facturaCol: null,
      totalCol: null,
      utilidadCol: null,
      margenCol: null,
      sucCol: null,
      vendedorCol: null,
      categoriaCol: null,
      clienteCol: null,
      descuentoCol: null,
      subtCol: null,
      costoCol: null,
      tipoFacCol: null,
      almacenCol: null
    };
    let yearsList = [];
    let monthsList = [];
    let almacenesList = [];

    const M2_SUCURSAL = {
      "general": 1538,
      "express": 369,
      "sanagust": 870,
      "sanagustin": 870,
      "adelitas": 348,
      "hilustres": 100,
      "h.ilustres": 100,
      "todas": 3225
    };

    (function(){
      $.pivotUtilities.locales = $.pivotUtilities.locales || {};
      $.pivotUtilities.locales.es = {
        localeStrings: {
          renderError: "Ocurri√≥ un error mostrando la tabla.",
          computeError: "Ocurri√≥ un error calculando la tabla.",
          uiRenderError: "Ocurri√≥ un error mostrando la interfaz.",
          selectAll: "Seleccionar todo",
          selectNone: "Deseleccionar todo",
          tooMany: "(demasiados valores)",
          filterResults: "Filtrar valores",
          apply: "Aplicar",
          cancel: "Cancelar",
          totals: "Totales",
          vs: "vs",
          by: "por",
          rendererName: "Tipo de vista",
          aggregatorName: "Tipo de c√°lculo",
          vals: "Valores",
          cols: "Columnas",
          rows: "Filas"
        }
      };
    })();

    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const tabId = btn.dataset.tab;
        document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
        document.getElementById("yoy-kpis").style.display =
          tabId === "yoy-tab" ? "flex" : "none";
      });
    });

    document.getElementById("file-input").addEventListener("change", function(e){
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      document.getElementById("status").textContent = "Leyendo archivo...";

      Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function(res){
          let data = res.data || [];
          if (!data.length) {
            document.getElementById("status").textContent = "Archivo sin registros.";
            return;
          }

          data = data.map(row => {
            const nuevo = {};
            Object.keys(row).forEach(k => {
              const limpio = k.trim();
              nuevo[limpio] = row[k];
            });
            return nuevo;
          });

          const headers = Object.keys(data[0]);

          const fechaCol     = encontrarColumna(headers, ["fecha"]);
          const facturaCol   = encontrarColumna(headers, ["factura"]);
          const totalCol     = encontrarColumna(headers, ["totalfac","total_fac","total"]);
          const utilidadCol  = encontrarColumna(headers, ["utilidad"]);
          const margenCol    = encontrarColumna(headers, ["margen"]);
          const sucCol       = encontrarColumna(headers, ["cvesuc","cve_suc","sucursal"]);
          const vendedorCol  = encontrarColumna(headers, ["vendedor"]);
          const categoriaCol = encontrarColumna(headers, ["categoria","categor√≠a"]);
          const clienteCol   = encontrarColumna(headers, ["cliente"]);
          const descuentoCol = encontrarColumna(headers, ["descuento"]);
          const subtCol      = encontrarColumna(headers, ["subtfac","subt_fac","subtotal"]);
          const costoCol     = encontrarColumna(headers, ["costo2","costo1"]);
          const tipoFacCol   = encontrarColumna(headers, ["tipodefactura","tipofactura","tipo de factura"]);
          const almacenCol   = encontrarColumna(headers, ["almacen","almac√©n"]);

          yearsList = [];
          monthsList = [];
          almacenesList = [];

          data.forEach(row => {
            if (fechaCol && row[fechaCol]) {
              const f = parseFecha(row[fechaCol]);
              if (f) {
                row["A√±o"] = f.year;
                row["Mes"] = f.month;
                row["Mes Nombre"] = MESES[f.month];
                row["A√±o-Mes"] = f.year + "-" + String(f.month).padStart(2,"0");
                if (!yearsList.includes(f.year)) yearsList.push(f.year);
                if (!monthsList.includes(f.month)) monthsList.push(f.month);
              }
            }
            if (almacenCol) {
              const al = row[almacenCol] ?? "(Sin almac√©n)";
              if (!almacenesList.includes(al)) almacenesList.push(al);
            } else if (sucCol) {
              const al = row[sucCol] ?? "(Sin sucursal)";
              if (!almacenesList.includes(al)) almacenesList.push(al);
            }
          });

          yearsList.sort((a,b)=>a-b);
          monthsList.sort((a,b)=>a-b);
          almacenesList.sort();

          rawData = data;
          meta = { fechaCol, facturaCol, totalCol, utilidadCol, margenCol, sucCol, vendedorCol,
                   categoriaCol, clienteCol, descuentoCol, subtCol,
                   costoCol, tipoFacCol, almacenCol };

          document.getElementById("status").textContent =
            "Archivo cargado: " + file.name + " (" + data.length + " filas).";

          inicializarPivotControles();
          renderPivotConFiltros();

          inicializarYoYControles();
          inicializarKpiControles();
        },
        error: function(err){
          document.getElementById("status").textContent = "Error al leer CSV: " + err.message;
        }
      });
    });

    /* ====================== EXPLORACI√ìN LIBRE ====================== */

    function inicializarPivotControles() {
      const ys = document.getElementById("pivot-year");
      const ms = document.getElementById("pivot-month");
      const ss = document.getElementById("pivot-store");
      const layoutSel = document.getElementById("pivot-layout");
      const aggSel = document.getElementById("pivot-agg");

      [ys,ms,ss,layoutSel,aggSel].forEach(sel=>{ while(sel.firstChild) sel.removeChild(sel.firstChild); });

      let opt = document.createElement("option");
      opt.value = ""; opt.textContent = "Todos";
      ys.appendChild(opt);
      yearsList.forEach(y=>{
        const o=document.createElement("option");
        o.value = y; o.textContent = y; ys.appendChild(o);
      });

      opt = document.createElement("option");
      opt.value=""; opt.textContent="Todos";
      ms.appendChild(opt);
      monthsList.forEach(m=>{
        const o=document.createElement("option");
        o.value = m; o.textContent = MESES[m] + " ("+m+")";
        ms.appendChild(o);
      });

      opt = document.createElement("option");
      opt.value="__ALL__"; opt.textContent="Todos los almacenes";
      ss.appendChild(opt);
      almacenesList.forEach(a=>{
        const o=document.createElement("option");
        o.value = a; o.textContent = a; ss.appendChild(o);
      });

      let o = document.createElement("option");
      o.value = "manual"; o.textContent = "Libre (arrastrar campos)";
      layoutSel.appendChild(o);

      if (meta.sucCol && meta.categoriaCol) {
        o = document.createElement("option");
        o.value = "suc_cat"; o.textContent = "Sucursal > Categor√≠a";
        layoutSel.appendChild(o);
      }
      if (meta.sucCol && meta.vendedorCol) {
        o = document.createElement("option");
        o.value = "suc_vend"; o.textContent = "Sucursal > Vendedor";
        layoutSel.appendChild(o);
      }
      if (meta.sucCol && meta.categoriaCol && rawData[0].hasOwnProperty("producto")) {
        o = document.createElement("option");
        o.value = "suc_cat_prod"; o.textContent = "Sucursal > Categor√≠a > Producto";
        layoutSel.appendChild(o);
      }
      if (meta.sucCol && meta.clienteCol) {
        o = document.createElement("option");
        o.value = "suc_cliente"; o.textContent = "Sucursal > Cliente";
        layoutSel.appendChild(o);
      }

      let oa = document.createElement("option");
      oa.value = "count_fact"; oa.textContent = "Conteo de facturas";
      aggSel.appendChild(oa);

      if (meta.totalCol) {
        oa = document.createElement("option");
        oa.value = "sum_total"; oa.textContent = "Suma " + meta.totalCol;
        aggSel.appendChild(oa);
      }
      if (meta.utilidadCol) {
        oa = document.createElement("option");
        oa.value = "sum_utilidad"; oa.textContent = "Suma " + meta.utilidadCol;
        aggSel.appendChild(oa);
      }
      if (meta.margenCol) {
        oa = document.createElement("option");
        oa.value = "avg_margen"; oa.textContent = "Promedio " + meta.margenCol;
        aggSel.appendChild(oa);
      }

      ys.onchange = ms.onchange = ss.onchange = renderPivotConFiltros;
      document.getElementById("pivot-apply").onclick = renderPivotConFiltros;
    }

    function obtenerDatosFiltradosPivot() {
      const year = parseInt(document.getElementById("pivot-year").value || "0",10);
      const month = parseInt(document.getElementById("pivot-month").value || "0",10);
      const store = document.getElementById("pivot-store").value;
      const almCol = meta.almacenCol || meta.sucCol;

      return rawData.filter(r=>{
        if (year && r["A√±o"] != year) return false;
        if (month && r["Mes"] != month) return false;
        if (almCol && store && store !== "__ALL__") {
          return (r[almCol] ?? "(Sin almac√©n)") == store;
        }
        return true;
      });
    }

    function renderPivotConFiltros() {
      if (!rawData.length) return;
      const data = obtenerDatosFiltradosPivot();

      const renderers = $.extend($.pivotUtilities.renderers,
                                 $.pivotUtilities.plotly_renderers || {});

      const layoutSel = document.getElementById("pivot-layout");
      const aggSel = document.getElementById("pivot-agg");
      const layout = layoutSel ? layoutSel.value : "manual";
      const agg = aggSel ? aggSel.value : "count_fact";

      let rows = [];
      let cols = data[0] && data[0].hasOwnProperty("A√±o") ? ["A√±o"] : [];

      if (layout === "suc_cat" && meta.sucCol && meta.categoriaCol) {
        rows = [meta.sucCol, meta.categoriaCol];
      } else if (layout === "suc_vend" && meta.sucCol && meta.vendedorCol) {
        rows = [meta.sucCol, meta.vendedorCol];
      } else if (layout === "suc_cat_prod" && meta.sucCol && meta.categoriaCol && data[0].hasOwnProperty("producto")) {
        rows = [meta.sucCol, meta.categoriaCol, "producto"];
      } else if (layout === "suc_cliente" && meta.sucCol && meta.clienteCol) {
        rows = [meta.sucCol, meta.clienteCol];
      } else {
        rows = meta.sucCol ? [meta.sucCol] : [];
      }

      let aggregatorName = "Count";
      let vals = [];

      if (agg === "count_fact") {
        aggregatorName = "Count";
        vals = [];
      } else if (agg === "sum_total" && meta.totalCol) {
        aggregatorName = "Sum";
        vals = [meta.totalCol];
      } else if (agg === "sum_utilidad" && meta.utilidadCol) {
        aggregatorName = "Sum";
        vals = [meta.utilidadCol];
      } else if (agg === "avg_margen" && meta.margenCol) {
        aggregatorName = "Average";
        vals = [meta.margenCol];
      }

      $("#pivot-output").empty();
      try {
        $("#pivot-output").pivotUI(
          data,
          {
            locale: "es",
            renderers: renderers,
            rows: rows,
            cols: cols,
            vals: vals,
            aggregatorName: aggregatorName,
            rendererName: "Table"
          },
          true
        );
      } catch (e) {
        console.error(e);
        document.getElementById("pivot-output").innerHTML =
          '<div style="color:#fca5a5;font-size:0.8rem;">Error al generar la tabla din√°mica: ' +
          e.message + '</div>';
      }
    }

    /* ====================== COMPARATIVO A√ëO VS A√ëO ====================== */

    function inicializarYoYControles() {
      const yearA = document.getElementById("yoy-year-a");
      const yearB = document.getElementById("yoy-year-b");
      const monthSel = document.getElementById("yoy-month");
      const metricSel = document.getElementById("yoy-metric");
      const groupSel = document.getElementById("yoy-group");

      [yearA, yearB, monthSel, metricSel, groupSel].forEach(sel => {
        while (sel.firstChild) sel.removeChild(sel.firstChild);
      });

      const oEmptyY = document.createElement("option");
      oEmptyY.value = ""; oEmptyY.textContent = "Selecciona a√±o‚Ä¶";
      yearA.appendChild(oEmptyY.cloneNode(true));
      yearB.appendChild(oEmptyY.cloneNode(true));
      yearsList.forEach(y=>{
        const o1 = document.createElement("option");
        o1.value = y; o1.textContent = y; yearA.appendChild(o1);
        const o2 = document.createElement("option");
        o2.value = y; o2.textContent = y; yearB.appendChild(o2);
      });

      const oEmptyM = document.createElement("option");
      oEmptyM.value = ""; oEmptyM.textContent = "Selecciona mes‚Ä¶";
      monthSel.appendChild(oEmptyM);
      monthsList.forEach(m=>{
        const opt = document.createElement("option");
        opt.value = m; opt.textContent = MESES[m] + " (" + m + ")";
        monthSel.appendChild(opt);
      });

      const metrics = [];
      if (meta.totalCol)    metrics.push({ value: meta.totalCol, label: "Total facturado ("+meta.totalCol+")" });
      if (meta.utilidadCol) metrics.push({ value: meta.utilidadCol, label: "Utilidad ("+meta.utilidadCol+")" });
      if (meta.margenCol)   metrics.push({ value: meta.margenCol, label: "Margen ("+meta.margenCol+")" });

      const oEmptyMet = document.createElement("option");
      oEmptyMet.value = ""; oEmptyMet.textContent = "Selecciona m√©trica‚Ä¶";
      metricSel.appendChild(oEmptyMet);
      metrics.forEach(m=>{
        const opt = document.createElement("option");
        opt.value = m.value; opt.textContent = m.label; metricSel.appendChild(opt);
      });

      const groups = [];
      if (meta.sucCol)       groups.push({ value: meta.sucCol, label: "Sucursal ("+meta.sucCol+")" });
      if (meta.vendedorCol)  groups.push({ value: meta.vendedorCol, label: "Vendedor ("+meta.vendedorCol+")" });
      if (meta.categoriaCol) groups.push({ value: meta.categoriaCol, label: "Categor√≠a ("+meta.categoriaCol+")" });
      if (meta.clienteCol)   groups.push({ value: meta.clienteCol, label: "Cliente ("+meta.clienteCol+")" });

      const oEmptyG = document.createElement("option");
      oEmptyG.value = ""; oEmptyG.textContent = "Total (sin agrupar)";
      groupSel.appendChild(oEmptyG);
      groups.forEach(g=>{
        const opt = document.createElement("option");
        opt.value = g.value; opt.textContent = g.label; groupSel.appendChild(opt);
      });
    }

    document.getElementById("yoy-run").addEventListener("click", calcularYoY);

    function calcularYoY() {
      if (!rawData.length || !meta.fechaCol) {
        document.getElementById("yoy-summary").textContent = "No hay datos o falta la columna fecha.";
        return;
      }
      const yearA = document.getElementById("yoy-year-a").value;
      const yearB = document.getElementById("yoy-year-b").value;
      const month = parseInt(document.getElementById("yoy-month").value || "0",10);
      const metric = document.getElementById("yoy-metric").value;
      const groupCol = document.getElementById("yoy-group").value;

      if (!yearA || !yearB || !month || !metric) {
        document.getElementById("yoy-summary").textContent =
          "Selecciona A√±o A, A√±o B, Mes y M√©trica.";
        return;
      }

      const map = {};
      rawData.forEach(r => {
        if (r["A√±o"] == yearA || r["A√±o"] == yearB) {
          if (r["Mes"] != month) return;
          const key = groupCol ? (r[groupCol] ?? "(Sin valor)") : "TOTAL";
          if (!map[key]) map[key] = { a:0, b:0 };
          const val = parseFloat(r[metric]) || 0;
          if (r["A√±o"] == yearA) map[key].a += val;
          if (r["A√±o"] == yearB) map[key].b += val;
        }
      });

      const rows = [];
      for (const k in map) {
        const a = map[k].a;
        const b = map[k].b;
        const diff = b - a;
        const pct = a === 0 ? (b === 0 ? NaN : Infinity) : (diff / a) * 100;
        rows.push({ group:k, a, b, diff, pct });
      }
      rows.sort((x,y)=>y.b - x.b);

      let tA=0, tB=0;
      rows.forEach(r=>{ tA+=r.a; tB+=r.b; });
      const tDiff = tB - tA;
      const tPct  = tA===0 ? (tB===0 ? NaN : Infinity) : (tDiff/tA)*100;

      document.getElementById("yoy-total-a").textContent = formatNumber(tA);
      document.getElementById("yoy-total-b").textContent = formatNumber(tB);
      document.getElementById("yoy-diff").textContent   = formatNumber(tDiff);
      document.getElementById("yoy-pct").textContent =
        isNaN(tPct) ? "‚Äì" : (!isFinite(tPct) ? "‚àû" : tPct.toFixed(1) + " %");

      document.getElementById("yoy-summary").textContent =
        MESES[month] + " " + yearA + ": " + formatNumber(tA) +
        " | " + MESES[month] + " " + yearB + ": " + formatNumber(tB) +
        " | Dif: " + formatNumber(tDiff) +
        " | Var %: " + (isNaN(tPct) ? "‚Äì" : (!isFinite(tPct) ? "‚àû" : tPct.toFixed(1) + " %"));

      const tableDiv = document.getElementById("yoy-table");
      tableDiv.innerHTML = "";
      if (!rows.length) {
        tableDiv.innerHTML = '<div class="hint">No hay datos para esa combinaci√≥n.</div>';
      } else {
        const table = document.createElement("table");
        table.className = "yoy";
        const thead = document.createElement("thead");
        const trh = document.createElement("tr");
        ["Grupo", "A√±o "+yearA, "A√±o "+yearB, "Diferencia", "Var %"].forEach(h=>{
          const th = document.createElement("th");
          th.textContent = h;
          trh.appendChild(th);
        });
        thead.appendChild(trh); table.appendChild(thead);

        const tbody = document.createElement("tbody");
        rows.forEach(r=>{
          const tr = document.createElement("tr");
          const pct = isNaN(r.pct) ? "‚Äì" : (!isFinite(r.pct) ? "‚àû" : r.pct.toFixed(1)+" %");
          [r.group, formatNumber(r.a), formatNumber(r.b), formatNumber(r.diff), pct].forEach(v=>{
            const td = document.createElement("td");
            td.textContent = v;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        tableDiv.appendChild(table);
      }

      const chartDiv = document.getElementById("yoy-chart");
      const labels = rows.map(r=>r.group);
      const dataA = rows.map(r=>r.a);
      const dataB = rows.map(r=>r.b);

      Plotly.newPlot(chartDiv, [
        { x: labels, y: dataA, type:"bar", name: "A√±o "+yearA },
        { x: labels, y: dataB, type:"bar", name: "A√±o "+yearB }
      ], {
        barmode: "group",
        margin: { t: 30, l: 40, r: 10, b: 80 },
        xaxis: { automargin:true },
        yaxis: { automargin:true, title: metric }
      }, {responsive:true});
    }

    /* ====================== KPIs VENTAS ====================== */

    function inicializarKpiControles() {
      const yA = document.getElementById("kpi-year-a-select");
      const yB = document.getElementById("kpi-year-b-select");
      const mSel = document.getElementById("kpi-month");
      const sSel = document.getElementById("kpi-store");

      [yA,yB,mSel,sSel].forEach(sel=>{ while (sel.firstChild) sel.removeChild(sel.firstChild); });

      const oEmptyY = document.createElement("option");
      oEmptyY.value = ""; oEmptyY.textContent = "A√±o‚Ä¶";
      yA.appendChild(oEmptyY.cloneNode(true));
      yB.appendChild(oEmptyY.cloneNode(true));
      yearsList.forEach(y=>{
        const o1=document.createElement("option"); o1.value=y;o1.textContent=y;yA.appendChild(o1);
        const o2=document.createElement("option"); o2.value=y;o2.textContent=y;yB.appendChild(o2);
      });

      const oAllMonths=document.createElement("option");
      oAllMonths.value="__ALL__"; oAllMonths.textContent="Todos los meses";
      mSel.appendChild(oAllMonths);
      monthsList.forEach(m=>{
        const opt=document.createElement("option");
        opt.value=m; opt.textContent=MESES[m]+" ("+m+")"; mSel.appendChild(opt);
      });

      const oAll=document.createElement("option");
      oAll.value="__ALL__"; oAll.textContent="Todos los almacenes";
      sSel.appendChild(oAll);
      almacenesList.forEach(a=>{
        const opt=document.createElement("option");
        opt.value=a; opt.textContent=a; sSel.appendChild(opt);
      });
    }

    document.getElementById("kpi-run").addEventListener("click", calcularKPIs);

    function filtrarDatos(year, monthValue, almacenValue) {
      const almCol = meta.almacenCol || meta.sucCol;
      const month = (monthValue === "__ALL__" || !monthValue) ? 0 : parseInt(monthValue,10);

      return rawData.filter(r=>{
        if (r["A√±o"] != year) return false;
        if (month && r["Mes"] != month) return false;
        if (almCol && almacenValue && almacenValue !== "__ALL__") {
          return (r[almCol] ?? "(Sin almac√©n)") == almacenValue;
        }
        return true;
      });
    }

    function calcularResumen(dataset, m2Sucursal) {
      let ventasTotal = 0;
      let ventasContado = 0;
      let ventasCredito = 0;
      let utilidadTotal = 0;
      let costoTotal = 0;
      let descuentoTotal = 0;
      let subtotalTotal = 0;

      const facturasSet = new Set();

      dataset.forEach(r=>{
        const v = meta.totalCol ? (parseFloat(r[meta.totalCol]) || 0) : 0;
        const u = meta.utilidadCol ? (parseFloat(r[meta.utilidadCol]) || 0) : 0;
        const c = meta.costoCol ? (parseFloat(r[meta.costoCol]) || 0) : 0;
        const d = meta.descuentoCol ? (parseFloat(r[meta.descuentoCol]) || 0) : 0;
        const s = meta.subtCol ? (parseFloat(r[meta.subtCol]) || 0) : 0;

        ventasTotal += v;
        utilidadTotal += u;
        costoTotal += c;
        descuentoTotal += d;
        subtotalTotal += s;

        if (meta.facturaCol && r[meta.facturaCol] != null) {
          facturasSet.add(String(r[meta.facturaCol]));
        }

        if (meta.tipoFacCol && r[meta.tipoFacCol]) {
          const tf = String(r[meta.tipoFacCol]).toLowerCase();
          if (tf.includes("contado")) ventasContado += v;
          else if (tf.includes("credito") || tf.includes("cr√©dito")) ventasCredito += v;
          else ventasContado += v;
        } else {
          ventasContado += v;
        }
      });

      const nFacturas = facturasSet.size;

      const baseDesc = (subtotalTotal + descuentoTotal) || (ventasTotal + descuentoTotal);
      const pctDesc = baseDesc ? (descuentoTotal / baseDesc) * 100 : NaN;
      const margenPct = ventasTotal ? (utilidadTotal / ventasTotal) * 100 : NaN;
      const ticketProm = nFacturas ? (ventasTotal / nFacturas) : NaN;
      const pctCosto = ventasTotal ? (costoTotal / ventasTotal) * 100 : NaN;

      let ventaPorM2 = NaN;
      let utilidadPorM2 = NaN;
      if (m2Sucursal && m2Sucursal > 0) {
        ventaPorM2 = ventasTotal / m2Sucursal;
        utilidadPorM2 = utilidadTotal / m2Sucursal;
      }

      return {
        ventasTotal,
        ventasContado,
        ventasCredito,
        utilidadTotal,
        costoTotal,
        pctDesc,
        margenPct,
        ticketProm,
        pctCosto,
        ventaPorM2,
        utilidadPorM2
      };
    }

    function calcularKPIs() {
      if (!rawData.length) {
        document.getElementById("kpi-summary").textContent = "No hay datos cargados.";
        return;
      }
      const yearA = document.getElementById("kpi-year-a-select").value;
      const yearB = document.getElementById("kpi-year-b-select").value;
      const monthValue = document.getElementById("kpi-month").value;
      const store = document.getElementById("kpi-store").value;

      if (!yearA || !yearB) {
        document.getElementById("kpi-summary").textContent =
          "Selecciona A√±o A y A√±o B (el mes puede ser 'Todos los meses').";
        return;
      }

      let m2Sucursal = null;
      if (store && store !== "__ALL__") {
        const key = normalizarNombre(store);
        m2Sucursal = M2_SUCURSAL[key] || null;
      } else {
        m2Sucursal = M2_SUCURSAL["todas"] || null;
      }

      const dataA = filtrarDatos(yearA, monthValue, store);
      const dataB = filtrarDatos(yearB, monthValue, store);

      const rA = calcularResumen(dataA, m2Sucursal);
      const rB = calcularResumen(dataB, m2Sucursal);

      const kpis = [
        {
          kpi: "% Descuento Promedio",
          detalle: "Descuento medio aplicado",
          tipo: "percent",
          a: rA.pctDesc, b: rB.pctDesc
        },
        {
          kpi: "Ventas Totales Contado $",
          detalle: "Ingreso neto contado",
          tipo: "money",
          a: rA.ventasContado, b: rB.ventasContado
        },
        {
          kpi: "Ventas Totales Cr√©dito $",
          detalle: "Ingreso neto cr√©dito",
          tipo: "money",
          a: rA.ventasCredito, b: rB.ventasCredito
        },
        {
          kpi: "Utilidad Total $",
          detalle: "Ganancia bruta",
          tipo: "money",
          a: rA.utilidadTotal, b: rB.utilidadTotal
        },
        {
          kpi: "Margen de Utilidad %",
          detalle: "Rentabilidad bruta",
          tipo: "percent",
          a: rA.margenPct, b: rB.margenPct
        },
        {
          kpi: "Ticket Promedio $",
          detalle: "$ por operaci√≥n (factura √∫nica)",
          tipo: "money",
          a: rA.ticketProm, b: rB.ticketProm
        },
        {
          kpi: "Costo de Venta $",
          detalle: "COGS consolidado",
          tipo: "money",
          a: rA.costoTotal, b: rB.costoTotal
        },
        {
          kpi: "% Costo de Venta",
          detalle: "Costo / Ventas",
          tipo: "percent",
          a: rA.pctCosto, b: rB.pctCosto
        },
        {
          kpi: "Venta por m¬≤ $",
          detalle: "Productividad de piso",
          tipo: "money",
          a: rA.ventaPorM2, b: rB.ventaPorM2
        },
        {
          kpi: "Utilidad por m¬≤ $",
          detalle: "Margen por espacio",
          tipo: "money",
          a: rA.utilidadPorM2, b: rB.utilidadPorM2
        }
      ];

      const tableDiv = document.getElementById("kpi-table");
      tableDiv.innerHTML = "";
      const table = document.createElement("table");
      table.className = "kpi";
      const thead = document.createElement("thead");
      const trh = document.createElement("tr");
      ["KPI","Detalle",""+yearA,""+yearB,"YoY"].forEach(h=>{
        const th=document.createElement("th"); th.textContent=h; trh.appendChild(th);
      });
      thead.appendChild(trh); table.appendChild(thead);

      const tbody=document.createElement("tbody");
      kpis.forEach(row=>{
        const tr=document.createElement("tr");
        const diff = (row.a==null||row.b==null||isNaN(row.a)||isNaN(row.b)) ? NaN : (row.b - row.a);
        let valA, valB, valYoY;
        if (row.tipo==="money") {
          valA = formatNumber(row.a);
          valB = formatNumber(row.b);
          valYoY = isNaN(diff) ? "‚Äì" : formatNumber(diff);
        } else {
          valA = isNaN(row.a) ? "‚Äì" : row.a.toFixed(1)+" %";
          valB = isNaN(row.b) ? "‚Äì" : row.b.toFixed(1)+" %";
          valYoY = isNaN(diff) ? "‚Äì" : diff.toFixed(1)+" pts";
        }
        [row.kpi,row.detalle,valA,valB,valYoY].forEach(v=>{
          const td=document.createElement("td"); td.textContent=v; tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      tableDiv.appendChild(table);

      const monthValue = document.getElementById("kpi-month").value;
      const monthDesc = (monthValue==="__ALL__" || !monthValue)
        ? "Todos los meses"
        : MESES[parseInt(monthValue,10)] + " (" + monthValue + ")";
      const descAlm = (store && store!=="__ALL__") ? (" | Almac√©n: "+store) : " | Todos los almacenes";
      document.getElementById("kpi-summary").textContent =
        monthDesc+" "+yearA+" vs "+monthDesc+" "+yearB + descAlm +
        (m2Sucursal ? " | m¬≤: "+formatNumber(m2Sucursal,0) : " | m¬≤: (sin dato)");
    }
  </script>
</body>
</html>
