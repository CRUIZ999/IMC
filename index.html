<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Analizador de Ventas ‚Äì Ferreter√≠a El Cedro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ESTILOS -->
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #0f172a;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 1rem 1.5rem;
      background: linear-gradient(90deg, #ea580c, #f97316);
      color: #0f172a;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    header h1 {
      font-size: 1.6rem;
      font-weight: 800;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    header h1 span.logo {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      background: #0f172a;
      color: #f97316;
      font-size: 1.3rem;
      box-shadow: 0 0 0 2px rgba(15,23,42,0.6);
    }

    header .subtitle {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    main {
      padding: 1.25rem 1.5rem 2rem;
      max-width: 1500px;
      width: 100%;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 1rem;
    }

    @media (max-width: 1024px) {
      main {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: radial-gradient(circle at top left, rgba(248,113,113,0.08), transparent 55%) #020617;
      border-radius: 1rem;
      padding: 1rem 1.1rem;
      border: 1px solid rgba(148,163,184,0.3);
      box-shadow: 0 18px 40px rgba(15,23,42,0.7);
    }

    .card h2 {
      font-size: 1rem;
      margin-bottom: 0.7rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-weight: 700;
      color: #e5e7eb;
    }

    .card h2 span.icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      background: rgba(248,250,252,0.08);
    }

    label {
      font-size: 0.8rem;
      margin-bottom: 0.25rem;
      display: block;
      color: #9ca3af;
    }

    select,
    input[type="file"],
    input[type="number"],
    button {
      width: 100%;
      padding: 0.45rem 0.6rem;
      border-radius: 0.45rem;
      border: 1px solid rgba(148,163,184,0.5);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.85rem;
      outline: none;
    }

    select:focus,
    input[type="file"]:focus,
    input[type="number"]:focus {
      border-color: #f97316;
      box-shadow: 0 0 0 1px rgba(249,115,22,0.7);
    }

    button {
      border: none;
      background: linear-gradient(135deg, #fb923c, #f97316);
      color: #0f172a;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.08s ease, box-shadow 0.08s ease, filter 0.1s;
      box-shadow: 0 12px 25px rgba(249,115,22,0.6);
    }

    button:hover {
      transform: translateY(-1px);
      filter: brightness(1.02);
    }

    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 6px 15px rgba(249,115,22,0.5);
    }

    .btn-secondary {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow: none;
    }

    .btn-secondary:hover {
      filter: brightness(1.1);
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .sidebar .hint {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.4rem;
      line-height: 1.4;
    }

    .sidebar .field {
      margin-bottom: 0.5rem;
    }

    .sidebar .field-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.45rem;
    }

    .sidebar hr {
      border: none;
      border-top: 1px dashed rgba(148,163,184,0.4);
      margin: 0.7rem 0;
    }

    .content-area {
      display: flex;
      flex-direction: column;
      gap: 0.9rem;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 0.7rem;
    }

    .kpi {
      padding: 0.6rem 0.75rem;
      border-radius: 0.9rem;
      border: 1px solid rgba(148,163,184,0.4);
      background: linear-gradient(145deg, rgba(15,23,42,0.95), rgba(30,64,175,0.55));
      box-shadow: 0 14px 30px rgba(15,23,42,0.65);
    }

    .kpi .label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: #9ca3af;
      margin-bottom: 0.2rem;
    }

    .kpi .value {
      font-size: 1.2rem;
      font-weight: 800;
      color: #f9fafb;
    }

    .kpi .sub {
      font-size: 0.7rem;
      color: #9ca3af;
      margin-top: 0.15rem;
    }

    .flex-row {
      display: flex;
      gap: 0.9rem;
      flex-wrap: wrap;
    }

    .flex-col {
      flex: 1 1 280px;
      min-width: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
      margin-top: 0.4rem;
    }

    th,
    td {
      border-bottom: 1px solid rgba(55,65,81,0.9);
      padding: 0.3rem 0.4rem;
      text-align: right;
      white-space: nowrap;
    }

    th {
      background: rgba(15,23,42,0.95);
      position: sticky;
      top: 0;
      z-index: 5;
      text-align: left;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    td:first-child,
    th:first-child {
      text-align: left;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.6);
    }

    .table-container {
      max-height: 260px;
      overflow: auto;
      border-radius: 0.7rem;
      border: 1px solid rgba(75,85,99,0.9);
      background: radial-gradient(circle at top, rgba(148,163,184,0.25), rgba(15,23,42,0.95));
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.18rem 0.45rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: rgba(15,23,42,0.92);
      border: 1px solid rgba(148,163,184,0.6);
      color: #e5e7eb;
    }

    .tag-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.75rem;
      padding: 0.15rem 0.35rem;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
      color: #9ca3af;
    }

    .status-pill span.dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #facc15;
    }

    .muted {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      margin-top: 0.25rem;
    }

    .chip {
      font-size: 0.7rem;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      opacity: 0.85;
    }

    .empty-state {
      font-size: 0.8rem;
      color: #9ca3af;
      padding: 0.4rem 0.2rem 0.7rem;
    }

    footer {
      padding: 0.7rem 1.5rem 1rem;
      font-size: 0.7rem;
      color: #6b7280;
      text-align: center;
    }

    .section-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }

    .badge {
      font-size: 0.7rem;
      padding: 0.12rem 0.38rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
    }

    .yoy-summary {
      font-size: 0.75rem;
      color: #e5e7eb;
      margin-top: 0.3rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .yoy-summary span {
      padding: 0.15rem 0.4rem;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.6);
    }
  </style>

  <!-- LIBRER√çAS -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <div>
      <h1>
        <span class="logo">üîß</span>
        Panel de Ventas ‚Äì El Cedro
      </h1>
      <div class="subtitle">
        Sube tu archivo de ventas y arma an√°lisis detallados, incluyendo comparativo A√±o vs A√±o del mismo mes.
      </div>
    </div>
    <div class="status-pill">
      <span class="dot"></span>
      Listo para analizar CSV
    </div>
  </header>

  <main>
    <!-- SIDEBAR -->
    <aside class="sidebar card">
      <h2><span class="icon">üìÇ</span>Archivo & Filtros</h2>

      <div class="field">
        <label for="file-input">Archivo CSV de ventas</label>
        <input type="file" id="file-input" accept=".csv,text/csv" />
        <div class="hint">
          üëâ Exporta tu archivo de Excel/Sheets como <b>CSV</b> y s√∫belo aqu√≠.<br>
          Incluye columnas como A√±o, Mes, Sucursal, Vendedor, Contado, Cr√©dito, Utilidad, etc.
        </div>
      </div>

      <hr />

      <h2><span class="icon">üéõÔ∏è</span>Filtros por dimensiones</h2>

      <div class="field">
        <label>Filtro 1 (opcional)</label>
        <div class="field-row">
          <select id="filter1-column">
            <option value="">Columna‚Ä¶</option>
          </select>
          <select id="filter1-value">
            <option value="">Valor‚Ä¶</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label>Filtro 2 (opcional)</label>
        <div class="field-row">
          <select id="filter2-column">
            <option value="">Columna‚Ä¶</option>
          </select>
          <select id="filter2-value">
            <option value="">Valor‚Ä¶</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label>Filtro 3 (opcional)</label>
        <div class="field-row">
          <select id="filter3-column">
            <option value="">Columna‚Ä¶</option>
          </select>
          <select id="filter3-value">
            <option value="">Valor‚Ä¶</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label>Filtro por rango de m√©trica (opcional)</label>
        <select id="range-metric-column">
          <option value="">M√©trica‚Ä¶</option>
        </select>
        <div class="field-row" style="margin-top:0.3rem;">
          <input type="number" id="range-metric-min" placeholder="M√≠n" />
          <input type="number" id="range-metric-max" placeholder="M√°x" />
        </div>
        <div class="hint">
          Ejemplos: utilidad &gt; 0, venta &lt;= 10,000, margen entre 20 y 40, etc.
        </div>
      </div>

      <div class="field-row" style="margin-top:0.4rem;">
        <button id="apply-filters-btn">Aplicar filtros</button>
        <button id="clear-filters-btn" class="btn-secondary">Limpiar</button>
      </div>

      <div class="hint">
        üí° Usa Filtro 1 para Sucursal, Filtro 2 para Vendedor, Filtro 3 para Categor√≠a, por ejemplo.
      </div>

      <hr />

      <h2 style="margin-top:0.3rem;"><span class="icon">üìä</span>Agrupaci√≥n general</h2>

      <div class="field">
        <label for="group-by-select">Agrupar por</label>
        <select id="group-by-select">
          <option value="">Selecciona columna‚Ä¶</option>
        </select>
      </div>

      <div class="field">
        <label for="metric-select">M√©trica num√©rica</label>
        <select id="metric-select">
          <option value="">Selecciona m√©trica‚Ä¶</option>
        </select>
      </div>

      <div class="field">
        <label for="agg-type-select">Tipo de c√°lculo</label>
        <select id="agg-type-select">
          <option value="sum">Suma</option>
          <option value="avg">Promedio</option>
          <option value="count">Conteo</option>
          <option value="max">M√°ximo</option>
          <option value="min">M√≠nimo</option>
        </select>
      </div>

      <button id="update-agg-btn" style="margin-top:0.4rem;">Actualizar resumen</button>

      <div class="hint">
        üéØ Ejemplo: agrupa por <b>Categor√≠a</b> y usa como m√©trica <b>Venta Total</b> o <b>Utilidad</b>.
      </div>

      <hr />

      <h2 style="margin-top:0.3rem;"><span class="icon">‚è±Ô∏è</span>Configuraci√≥n A√±o / Mes</h2>
      <div class="field">
        <label for="year-column-select">Columna de A√±o</label>
        <select id="year-column-select">
          <option value="">Selecciona columna‚Ä¶</option>
        </select>
      </div>
      <div class="field">
        <label for="month-column-select">Columna de Mes</label>
        <select id="month-column-select">
          <option value="">Selecciona columna‚Ä¶</option>
        </select>
        <div class="hint">
          Puede ser n√∫mero (1‚Äì12) o nombre de mes (enero, febrero‚Ä¶).
        </div>
      </div>
    </aside>

    <!-- CONTENIDO PRINCIPAL -->
    <section class="content-area">
      <!-- KPIs -->
      <div class="card">
        <div class="section-title-row">
          <h2><span class="icon">üìå</span>Indicadores r√°pidos</h2>
          <div class="chip-row" id="kpi-tags">
            <span class="chip">Esperando archivo‚Ä¶</span>
          </div>
        </div>
        <div class="kpi-grid">
          <div class="kpi">
            <div class="label">Registros (filas)</div>
            <div class="value" id="kpi-rows">‚Äì</div>
            <div class="sub">Total de registros cargados tras los filtros.</div>
          </div>
          <div class="kpi">
            <div class="label">Suma m√©trica seleccionada</div>
            <div class="value" id="kpi-metric-sum">‚Äì</div>
            <div class="sub" id="kpi-metric-sum-label">Selecciona una m√©trica num√©rica.</div>
          </div>
          <div class="kpi">
            <div class="label">Promedio m√©trica seleccionada</div>
            <div class="value" id="kpi-metric-avg">‚Äì</div>
            <div class="sub">En base a los registros filtrados.</div>
          </div>
          <div class="kpi">
            <div class="label">Columnas detectadas</div>
            <div class="value" id="kpi-cols">‚Äì</div>
            <div class="sub" id="kpi-cols-detail">‚Äì</div>
          </div>
        </div>
      </div>

      <!-- Resumen agrupado + gr√°fica general -->
      <div class="flex-row">
        <div class="flex-col card">
          <div class="section-title-row">
            <h2><span class="icon">üìà</span>Resumen agrupado (tipo tabla din√°mica)</h2>
            <span class="badge">Top 15 grupos</span>
          </div>
          <div class="muted">
            Ideal para comparar sucursales, vendedores, categor√≠as, clientes, etc.
          </div>
          <div id="group-table-container" class="table-container" style="margin-top:0.4rem;">
            <div class="empty-state">Carga un archivo y elige "Agrupar por" + "M√©trica" para ver el resumen.</div>
          </div>
        </div>

        <div class="flex-col card">
          <h2><span class="icon">üìâ</span>Gr√°fica comparativa general</h2>
          <div class="muted">
            Barra por grupo, basada en la configuraci√≥n de agrupaci√≥n general.
          </div>
          <div style="height:260px;margin-top:0.6rem;">
            <canvas id="group-chart"></canvas>
          </div>
        </div>
      </div>

      <!-- COMPARATIVO A√ëO VS A√ëO (MISMO MES) -->
      <div class="card">
        <div class="section-title-row">
          <h2><span class="icon">üìÖ</span>Comparativo A√±o vs A√±o (mismo mes)</h2>
          <span class="badge">YoY mismo mes</span>
        </div>
        <div class="muted">
          Selecciona columna de A√±o y de Mes, el mes a comparar, los dos a√±os, la m√©trica y c√≥mo quieres agrupar (ej. por Sucursal).
        </div>

        <div class="flex-row" style="margin-top:0.6rem; gap:0.7rem;">
          <div class="flex-col">
            <div class="field">
              <label for="yoy-month-value-select">Mes a comparar</label>
              <select id="yoy-month-value-select">
                <option value="">Selecciona mes‚Ä¶</option>
              </select>
            </div>
          </div>
          <div class="flex-col">
            <div class="field">
              <label for="yoy-year-a-select">A√±o A</label>
              <select id="yoy-year-a-select">
                <option value="">Selecciona a√±o‚Ä¶</option>
              </select>
            </div>
          </div>
          <div class="flex-col">
            <div class="field">
              <label for="yoy-year-b-select">A√±o B</label>
              <select id="yoy-year-b-select">
                <option value="">Selecciona a√±o‚Ä¶</option>
              </select>
            </div>
          </div>
        </div>

        <div class="flex-row" style="margin-top:0.4rem; gap:0.7rem;">
          <div class="flex-col">
            <div class="field">
              <label for="yoy-metric-select">M√©trica a comparar</label>
              <select id="yoy-metric-select">
                <option value="">Selecciona m√©trica‚Ä¶</option>
              </select>
            </div>
          </div>
          <div class="flex-col">
            <div class="field">
              <label for="yoy-group-by-select">Agrupar por (opcional)</label>
              <select id="yoy-group-by-select">
                <option value="">Sin agrupaci√≥n (Total)</option>
              </select>
            </div>
          </div>
          <div class="flex-col" style="align-self:flex-end;">
            <button id="yoy-run-btn">Calcular comparativo</button>
          </div>
        </div>

        <div class="yoy-summary" id="yoy-summary"></div>

        <div class="flex-row" style="margin-top:0.6rem;">
          <div class="flex-col">
            <div id="yoy-table-container" class="table-container">
              <div class="empty-state">
                Configura A√±o/Mes en el panel izquierdo y luego selecciona mes + a√±os + m√©trica para ver el comparativo.
              </div>
            </div>
          </div>
          <div class="flex-col">
            <div style="height:260px;">
              <canvas id="yoy-chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Vista previa de datos -->
      <div class="card">
        <h2><span class="icon">üßæ</span>Vista previa de datos filtrados</h2>
        <div class="muted">
          Solo se muestran las primeras filas para no saturar el navegador.
        </div>
        <div id="data-table-container" class="table-container" style="margin-top:0.4rem;">
          <div class="empty-state">Sin datos. Sube un CSV para iniciar.</div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    Hecho para Ferreter√≠a El Cedro ‚Äì An√°lisis detallado de ventas contado/cr√©dito, m√°rgenes, utilidad, vendedores, categor√≠as y comparativos A√±o vs A√±o.
  </footer>

  <!-- L√ìGICA -->
  <script>
    // -------------------------------------------------------------------
    // Estado global
    // -------------------------------------------------------------------
    let rawData = [];
    let filteredData = [];
    let columns = [];
    let numericColumns = [];
    let groupChartInstance = null;
    let yoyChartInstance = null;

    const fileInput = document.getElementById('file-input');

    const filter1ColumnSelect = document.getElementById('filter1-column');
    const filter1ValueSelect = document.getElementById('filter1-value');
    const filter2ColumnSelect = document.getElementById('filter2-column');
    const filter2ValueSelect = document.getElementById('filter2-value');
    const filter3ColumnSelect = document.getElementById('filter3-column');
    const filter3ValueSelect = document.getElementById('filter3-value');

    const rangeMetricColumnSelect = document.getElementById('range-metric-column');
    const rangeMetricMinInput = document.getElementById('range-metric-min');
    const rangeMetricMaxInput = document.getElementById('range-metric-max');

    const applyFiltersBtn = document.getElementById('apply-filters-btn');
    const clearFiltersBtn = document.getElementById('clear-filters-btn');

    const groupBySelect = document.getElementById('group-by-select');
    const metricSelect = document.getElementById('metric-select');
    const aggTypeSelect = document.getElementById('agg-type-select');
    const updateAggBtn = document.getElementById('update-agg-btn');

    const yearColumnSelect = document.getElementById('year-column-select');
    const monthColumnSelect = document.getElementById('month-column-select');

    const yoyMonthValueSelect = document.getElementById('yoy-month-value-select');
    const yoyYearASelect = document.getElementById('yoy-year-a-select');
    const yoyYearBSelect = document.getElementById('yoy-year-b-select');
    const yoyMetricSelect = document.getElementById('yoy-metric-select');
    const yoyGroupBySelect = document.getElementById('yoy-group-by-select');
    const yoyRunBtn = document.getElementById('yoy-run-btn');
    const yoyTableContainer = document.getElementById('yoy-table-container');
    const yoySummaryEl = document.getElementById('yoy-summary');
    const yoyChartCanvas = document.getElementById('yoy-chart');

    const kpiRowsEl = document.getElementById('kpi-rows');
    const kpiMetricSumEl = document.getElementById('kpi-metric-sum');
    const kpiMetricSumLabelEl = document.getElementById('kpi-metric-sum-label');
    const kpiMetricAvgEl = document.getElementById('kpi-metric-avg');
    const kpiColsEl = document.getElementById('kpi-cols');
    const kpiColsDetailEl = document.getElementById('kpi-cols-detail');
    const kpiTagsEl = document.getElementById('kpi-tags');

    const groupTableContainer = document.getElementById('group-table-container');
    const groupChartCanvas = document.getElementById('group-chart');
    const dataTableContainer = document.getElementById('data-table-container');

    // -------------------------------------------------------------------
    // Utilidades
    // -------------------------------------------------------------------
    function normalizeNumber(value) {
      if (value === null || value === undefined) return NaN;
      if (typeof value === 'number') return value;

      let s = String(value).trim();
      if (!s) return NaN;
      s = s.replace(/[$%]/g, '').replace(/\s/g, '');
      const commaCount = (s.match(/,/g) || []).length;
      const dotCount = (s.match(/\./g) || []).length;
      if (commaCount === 1 && dotCount === 0) {
        s = s.replace(',', '.');
      }
      s = s.replace(/,/g, '');
      const num = parseFloat(s);
      return isNaN(num) ? NaN : num;
    }

    function formatNumber(num) {
      if (num === null || num === undefined || isNaN(num)) return '‚Äì';
      return num.toLocaleString('es-MX', { maximumFractionDigits: 2 });
    }

    function createOption(value, label) {
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = label;
      return opt;
    }

    function uniqueValues(data, column) {
      const set = new Set();
      data.forEach(row => {
        set.add(row[column]);
      });
      return Array.from(set).filter(v => v !== undefined && v !== null && v !== '');
    }

    function detectNumericColumns(data) {
      if (!data.length) return [];
      const cols = Object.keys(data[0]);
      const numeric = [];

      cols.forEach(col => {
        let samples = 0;
        let numericSamples = 0;
        for (let i = 0; i < data.length && samples < 60; i++) {
          const v = data[i][col];
          if (v === '' || v === null || v === undefined) continue;
          samples++;
          const n = normalizeNumber(v);
          if (!isNaN(n)) numericSamples++;
        }
        if (samples > 0 && numericSamples / samples >= 0.6) {
          numeric.push(col);
        }
      });

      return numeric;
    }

    // -------------------------------------------------------------------
    // Carga de archivo CSV
    // -------------------------------------------------------------------
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        header: true,
        dynamicTyping: false,
        skipEmptyLines: true,
        complete: function(results) {
          rawData = results.data || [];
          filteredData = [...rawData];
          columns = rawData.length ? Object.keys(rawData[0]) : [];
          numericColumns = detectNumericColumns(rawData);

          llenarSelectsColumnas();
          actualizarKPIs();
          renderDataTable();
          renderGroupSummaryAndChart();
          actualizarYoYConfig();

          kpiTagsEl.innerHTML = '';
          const tag1 = document.createElement('span');
          tag1.className = 'chip';
          tag1.textContent = 'Archivo: ' + file.name;
          const tag2 = document.createElement('span');
          tag2.className = 'chip';
          tag2.textContent = numericColumns.length + ' columnas num√©ricas';
          kpiTagsEl.appendChild(tag1);
          kpiTagsEl.appendChild(tag2);
        },
        error: function(err) {
          alert('Ocurri√≥ un error al leer el CSV: ' + err.message);
        }
      });
    });

    // -------------------------------------------------------------------
    // Llenar selects de columnas
    // -------------------------------------------------------------------
    function limpiarSelect(sel, firstLabel) {
      while (sel.firstChild) sel.removeChild(sel.firstChild);
      if (firstLabel !== null) {
        sel.appendChild(createOption('', firstLabel));
      }
    }

    function llenarSelectsColumnas() {
      // Filtros
      limpiarSelect(filter1ColumnSelect, 'Columna‚Ä¶');
      limpiarSelect(filter2ColumnSelect, 'Columna‚Ä¶');
      limpiarSelect(filter3ColumnSelect, 'Columna‚Ä¶');
      limpiarSelect(filter1ValueSelect, 'Valor‚Ä¶');
      limpiarSelect(filter2ValueSelect, 'Valor‚Ä¶');
      limpiarSelect(filter3ValueSelect, 'Valor‚Ä¶');

      // Agrupaci√≥n general
      limpiarSelect(groupBySelect, 'Selecciona columna‚Ä¶');
      limpiarSelect(metricSelect, 'Selecciona m√©trica‚Ä¶');

      // Rango m√©trico
      limpiarSelect(rangeMetricColumnSelect, 'M√©trica‚Ä¶');

      // A√±o / Mes YoY
      limpiarSelect(yearColumnSelect, 'Selecciona columna‚Ä¶');
      limpiarSelect(monthColumnSelect, 'Selecciona columna‚Ä¶');

      // YoY selects
      limpiarSelect(yoyMonthValueSelect, 'Selecciona mes‚Ä¶');
      limpiarSelect(yoyYearASelect, 'Selecciona a√±o‚Ä¶');
      limpiarSelect(yoyYearBSelect, 'Selecciona a√±o‚Ä¶');
      limpiarSelect(yoyMetricSelect, 'Selecciona m√©trica‚Ä¶');
      limpiarSelect(yoyGroupBySelect, null);
      yoyGroupBySelect.appendChild(createOption('', 'Sin agrupaci√≥n (Total)'));

      // Llenar con todas las columnas
      columns.forEach(col => {
        filter1ColumnSelect.appendChild(createOption(col, col));
        filter2ColumnSelect.appendChild(createOption(col, col));
        filter3ColumnSelect.appendChild(createOption(col, col));

        groupBySelect.appendChild(createOption(col, col));

        yearColumnSelect.appendChild(createOption(col, col));
        monthColumnSelect.appendChild(createOption(col, col));
        yoyGroupBySelect.appendChild(createOption(col, col));
      });

      // M√©tricas num√©ricas
      numericColumns.forEach(col => {
        metricSelect.appendChild(createOption(col, col));
        rangeMetricColumnSelect.appendChild(createOption(col, col));
        yoyMetricSelect.appendChild(createOption(col, col));
      });

      // Preseleccionar posibles columnas t√≠picas
      const lowerCols = columns.map(c => c.toLowerCase());
      const probableGroup = ['sucursal','vendedor','categoria','categor√≠a','cliente'];
      const probableMetric = ['venta total','ventas','monto','utilidad','margen','contado','cr√©dito','credito'];
      const probableYear = ['a√±o','anio','year'];
      const probableMonth = ['mes'];

      let defaultGroup = '';
      for (const key of probableGroup) {
        const idx = lowerCols.indexOf(key);
        if (idx >= 0) { defaultGroup = columns[idx]; break; }
      }

      let defaultMetric = '';
      const lowerNumCols = numericColumns.map(c => c.toLowerCase());
      for (const key of probableMetric) {
        const idx = lowerNumCols.indexOf(key);
        if (idx >= 0) { defaultMetric = numericColumns[idx]; break; }
      }

      let defaultYear = '';
      for (const key of probableYear) {
        const idx = lowerCols.indexOf(key);
        if (idx >= 0) { defaultYear = columns[idx]; break; }
      }

      let defaultMonth = '';
      for (const key of probableMonth) {
        const idx = lowerCols.indexOf(key);
        if (idx >= 0) { defaultMonth = columns[idx]; break; }
      }

      if (defaultGroup) {
        groupBySelect.value = defaultGroup;
        yoyGroupBySelect.value = defaultGroup;
      }
      if (defaultMetric) {
        metricSelect.value = defaultMetric;
        yoyMetricSelect.value = defaultMetric;
        rangeMetricColumnSelect.value = defaultMetric;
      }
      if (defaultYear) yearColumnSelect.value = defaultYear;
      if (defaultMonth) monthColumnSelect.value = defaultMonth;

      actualizarYoYConfig();
    }

    // Cuando se elige columna de filtro, llenar valores posibles
    filter1ColumnSelect.addEventListener('change', () => {
      llenarValoresFiltro(filter1ColumnSelect, filter1ValueSelect);
    });
    filter2ColumnSelect.addEventListener('change', () => {
      llenarValoresFiltro(filter2ColumnSelect, filter2ValueSelect);
    });
    filter3ColumnSelect.addEventListener('change', () => {
      llenarValoresFiltro(filter3ColumnSelect, filter3ValueSelect);
    });

    function llenarValoresFiltro(colSelect, valSelect) {
      const col = colSelect.value;
      limpiarSelect(valSelect, 'Valor‚Ä¶');

      if (!col || !rawData.length) return;

      const valores = uniqueValues(rawData, col).sort();
      valSelect.appendChild(createOption('', 'Todos'));
      valores.forEach(v => {
        valSelect.appendChild(createOption(v, v));
      });
    }

    // -------------------------------------------------------------------
    // Aplicar / limpiar filtros
    // -------------------------------------------------------------------
    applyFiltersBtn.addEventListener('click', () => {
      aplicarFiltros();
      actualizarKPIs();
      renderDataTable();
      renderGroupSummaryAndChart();
      actualizarYoYConfig();
    });

    clearFiltersBtn.addEventListener('click', () => {
      // Reset selects
      filter1ColumnSelect.value = '';
      filter2ColumnSelect.value = '';
      filter3ColumnSelect.value = '';
      limpiarSelect(filter1ValueSelect, 'Valor‚Ä¶');
      limpiarSelect(filter2ValueSelect, 'Valor‚Ä¶');
      limpiarSelect(filter3ValueSelect, 'Valor‚Ä¶');

      rangeMetricColumnSelect.value = '';
      rangeMetricMinInput.value = '';
      rangeMetricMaxInput.value = '';

      filteredData = [...rawData];
      actualizarKPIs();
      renderDataTable();
      renderGroupSummaryAndChart();
      actualizarYoYConfig();
    });

    function aplicarFiltros() {
      if (!rawData.length) return;
      let data = [...rawData];

      const col1 = filter1ColumnSelect.value;
      const val1 = filter1ValueSelect.value;
      const col2 = filter2ColumnSelect.value;
      const val2 = filter2ValueSelect.value;
      const col3 = filter3ColumnSelect.value;
      const val3 = filter3ValueSelect.value;

      if (col1 && val1) {
        data = data.filter(row => String(row[col1]) === String(val1));
      }
      if (col2 && val2) {
        data = data.filter(row => String(row[col2]) === String(val2));
      }
      if (col3 && val3) {
        data = data.filter(row => String(row[col3]) === String(val3));
      }

      const rangeCol = rangeMetricColumnSelect.value;
      const minStr = rangeMetricMinInput.value;
      const maxStr = rangeMetricMaxInput.value;
      const hasMin = minStr !== '';
      const hasMax = maxStr !== '';

      if (rangeCol && (hasMin || hasMax)) {
        const minVal = hasMin ? parseFloat(minStr) : null;
        const maxVal = hasMax ? parseFloat(maxStr) : null;

        data = data.filter(row => {
          const n = normalizeNumber(row[rangeCol]);
          if (isNaN(n)) return false;
          if (minVal !== null && n < minVal) return false;
          if (maxVal !== null && n > maxVal) return false;
          return true;
        });
      }

      filteredData = data;
    }

    // -------------------------------------------------------------------
    // KPIs
    // -------------------------------------------------------------------
    function actualizarKPIs() {
      const rows = filteredData.length;
      kpiRowsEl.textContent = rows ? formatNumber(rows) : '‚Äì';

      kpiColsEl.textContent = columns.length ? columns.length : '‚Äì';
      if (columns.length) {
        kpiColsDetailEl.textContent = columns.slice(0, 5).join(', ') + (columns.length > 5 ? '‚Ä¶' : '');
      } else {
        kpiColsDetailEl.textContent = 'Sin columnas detectadas.';
      }

      const metric = metricSelect.value;
      if (!metric || !numericColumns.includes(metric)) {
        kpiMetricSumEl.textContent = '‚Äì';
        kpiMetricAvgEl.textContent = '‚Äì';
        kpiMetricSumLabelEl.textContent = 'Selecciona una m√©trica num√©rica.';
        return;
      }

      let sum = 0;
      let count = 0;
      filteredData.forEach(row => {
        const n = normalizeNumber(row[metric]);
        if (!isNaN(n)) {
          sum += n;
          count++;
        }
      });

      const avg = count ? sum / count : NaN;
      kpiMetricSumEl.textContent = formatNumber(sum);
      kpiMetricAvgEl.textContent = formatNumber(avg);
      kpiMetricSumLabelEl.textContent = 'Suma total de "' + metric + '".';
    }

    // -------------------------------------------------------------------
    // Agrupaci√≥n general
    // -------------------------------------------------------------------
    updateAggBtn.addEventListener('click', () => {
      actualizarKPIs();
      renderGroupSummaryAndChart();
    });

    function agruparDatos(data, groupCol, metricCol, aggType) {
      const groups = {};
      data.forEach(row => {
        const keyRaw = row[groupCol];
        const key = keyRaw === undefined || keyRaw === null || keyRaw === '' ? '(Sin valor)' : String(keyRaw);
        if (!groups[key]) {
          groups[key] = { count: 0, sum: 0, max: null, min: null };
        }
        groups[key].count++;
        const n = normalizeNumber(row[metricCol]);
        if (!isNaN(n)) {
          groups[key].sum += n;
          if (groups[key].max === null || n > groups[key].max) groups[key].max = n;
          if (groups[key].min === null || n < groups[key].min) groups[key].min = n;
        }
      });

      const result = [];
      for (const key in groups) {
        const g = groups[key];
        let value;
        switch (aggType) {
          case 'avg':
            value = g.count ? g.sum / g.count : NaN;
            break;
          case 'count':
            value = g.count;
            break;
          case 'max':
            value = g.max;
            break;
          case 'min':
            value = g.min;
            break;
          case 'sum':
          default:
            value = g.sum;
        }
        result.push({ group: key, value, count: g.count, sum: g.sum });
      }

      result.sort((a, b) => (isNaN(b.value) ? -1 : b.value) - (isNaN(a.value) ? -1 : a.value));
      return result;
    }

    function renderGroupSummaryAndChart() {
      groupTableContainer.innerHTML = '';
      const groupCol = groupBySelect.value;
      const metricCol = metricSelect.value;
      const aggType = aggTypeSelect.value;

      if (!filteredData.length) {
        groupTableContainer.innerHTML = '<div class="empty-state">No hay datos. Sube un CSV y aplica filtros.</div>';
        if (groupChartInstance) { groupChartInstance.destroy(); groupChartInstance = null; }
        return;
      }

      if (!groupCol || !metricCol) {
        groupTableContainer.innerHTML = '<div class="empty-state">Selecciona "Agrupar por" y una "M√©trica num√©rica" para ver el resumen.</div>';
        if (groupChartInstance) { groupChartInstance.destroy(); groupChartInstance = null; }
        return;
      }

      const grouped = agruparDatos(filteredData, groupCol, metricCol, aggType);
      const top = grouped.slice(0, 15);

      // Tabla
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const trHead = document.createElement('tr');
      ['Grupo ('+groupCol+')', 'Valor ('+aggType+')', 'Suma', 'Conteo'].forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      top.forEach(row => {
        const tr = document.createElement('tr');
        const tdGroup = document.createElement('td');
        const tdVal = document.createElement('td');
        const tdSum = document.createElement('td');
        const tdCount = document.createElement('td');

        tdGroup.textContent = row.group;
        tdVal.textContent = formatNumber(row.value);
        tdSum.textContent = formatNumber(row.sum);
        tdCount.textContent = formatNumber(row.count);

        tr.appendChild(tdGroup);
        tr.appendChild(tdVal);
        tr.appendChild(tdSum);
        tr.appendChild(tdCount);
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      groupTableContainer.appendChild(table);

      // Gr√°fica
      const labels = top.map(r => r.group);
      const values = top.map(r => isNaN(r.value) ? 0 : r.value);

      if (groupChartInstance) {
        groupChartInstance.destroy();
      }
      groupChartInstance = new Chart(groupChartCanvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: metricCol + ' (' + aggType + ')',
            data: values
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { color: '#e5e7eb', maxRotation: 45, minRotation: 0 },
              grid: { display: false }
            },
            y: {
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(148,163,184,0.3)' }
            }
          },
          plugins: {
            legend: { labels: { color: '#e5e7eb' } },
            tooltip: {
              callbacks: {
                label: function(ctx) {
                  return ' ' + formatNumber(ctx.raw);
                }
              }
            }
          }
        }
      });
    }

    // -------------------------------------------------------------------
    // Tabla de datos (vista previa)
    // -------------------------------------------------------------------
    function renderDataTable() {
      dataTableContainer.innerHTML = '';

      if (!filteredData.length) {
        dataTableContainer.innerHTML = '<div class="empty-state">No hay datos para mostrar. Revisa los filtros o sube un archivo.</div>';
        return;
      }

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const trHead = document.createElement('tr');
      columns.forEach(col => {
        const th = document.createElement('th');
        th.textContent = col;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      const maxRows = 80;
      filteredData.slice(0, maxRows).forEach(row => {
        const tr = document.createElement('tr');
        columns.forEach(col => {
          const td = document.createElement('td');
          td.textContent = row[col];
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      dataTableContainer.appendChild(table);

      if (filteredData.length > maxRows) {
        const note = document.createElement('div');
        note.className = 'muted';
        note.textContent = 'Mostrando solo las primeras ' + maxRows + ' filas de ' + filteredData.length + '.';
        dataTableContainer.appendChild(note);
      }
    }

    // -------------------------------------------------------------------
    // Configuraci√≥n y helpers para YoY
    // -------------------------------------------------------------------
    yearColumnSelect.addEventListener('change', actualizarYoYConfig);
    monthColumnSelect.addEventListener('change', actualizarYoYConfig);

    function actualizarYoYConfig() {
      yoyMonthValueSelect.innerHTML = '';
      yoyMonthValueSelect.appendChild(createOption('', 'Selecciona mes‚Ä¶'));
      yoyYearASelect.innerHTML = '';
      yoyYearASelect.appendChild(createOption('', 'Selecciona a√±o‚Ä¶'));
      yoyYearBSelect.innerHTML = '';
      yoyYearBSelect.appendChild(createOption('', 'Selecciona a√±o‚Ä¶'));

      const yearCol = yearColumnSelect.value;
      const monthCol = monthColumnSelect.value;

      if (!rawData.length || !yearCol || !monthCol) return;

      const meses = uniqueValues(rawData, monthCol);
      meses.sort();
      meses.forEach(m => {
        yoyMonthValueSelect.appendChild(createOption(m, m));
      });

      const years = uniqueValues(rawData, yearCol);
      years.sort();
      years.forEach(y => {
        yoyYearASelect.appendChild(createOption(y, y));
        yoyYearBSelect.appendChild(createOption(y, y));
      });
    }

    yoyRunBtn.addEventListener('click', () => {
      calcularYoY();
    });

    function calcularYoY() {
      yoyTableContainer.innerHTML = '';
      yoySummaryEl.innerHTML = '';

      const yearCol = yearColumnSelect.value;
      const monthCol = monthColumnSelect.value;
      const monthVal = yoyMonthValueSelect.value;
      const yearA = yoyYearASelect.value;
      const yearB = yoyYearBSelect.value;
      const metricCol = yoyMetricSelect.value;
      const groupCol = yoyGroupBySelect.value;

      if (!filteredData.length) {
        yoyTableContainer.innerHTML = '<div class="empty-state">No hay datos filtrados. Sube un archivo y aplica filtros.</div>';
        if (yoyChartInstance) { yoyChartInstance.destroy(); yoyChartInstance = null; }
        return;
      }

      if (!yearCol || !monthCol) {
        yoyTableContainer.innerHTML = '<div class="empty-state">Primero selecciona las columnas de A√±o y Mes en el panel izquierdo.</div>';
        if (yoyChartInstance) { yoyChartInstance.destroy(); yoyChartInstance = null; }
        return;
      }

      if (!monthVal || !yearA || !yearB || !metricCol) {
        yoyTableContainer.innerHTML = '<div class="empty-state">Selecciona mes, A√±o A, A√±o B y la m√©trica a comparar.</div>';
        if (yoyChartInstance) { yoyChartInstance.destroy(); yoyChartInstance = null; }
        return;
      }

      if (!numericColumns.includes(metricCol)) {
        yoyTableContainer.innerHTML = '<div class="empty-state">La m√©trica seleccionada no se detecta como num√©rica.</div>';
        if (yoyChartInstance) { yoyChartInstance.destroy(); yoyChartInstance = null; }
        return;
      }

      const dataMes = filteredData.filter(row => String(row[monthCol]) === String(monthVal) &&
                                                 (String(row[yearCol]) === String(yearA) || String(row[yearCol]) === String(yearB)));

      if (!dataMes.length) {
        yoyTableContainer.innerHTML = '<div class="empty-state">No hay datos para ese mes con los a√±os seleccionados despu√©s de filtros.</div>';
        if (yoyChartInstance) { yoyChartInstance.destroy(); yoyChartInstance = null; }
        return;
      }

      const groups = {};
      dataMes.forEach(row => {
        const yVal = String(row[yearCol]);
        const gKey = groupCol ? (row[groupCol] ?? '(Sin valor)') : 'TOTAL';
        const key = String(gKey);

        if (!groups[key]) {
          groups[key] = { sumA: 0, sumB: 0 };
        }

        const n = normalizeNumber(row[metricCol]);
        if (isNaN(n)) return;

        if (yVal === String(yearA)) {
          groups[key].sumA += n;
        } else if (yVal === String(yearB)) {
          groups[key].sumB += n;
        }
      });

      const rows = [];
      for (const g in groups) {
        const sA = groups[g].sumA;
        const sB = groups[g].sumB;
        const diff = sB - sA;
        const pct = sA === 0 ? (sB === 0 ? NaN : Infinity) : (diff / sA) * 100;
        rows.push({ group: g, sumA: sA, sumB: sB, diff, pct });
      }

      if (!rows.length) {
        yoyTableContainer.innerHTML = '<div class="empty-state">No hay datos num√©ricos v√°lidos para esa combinaci√≥n.</div>';
        if (yoyChartInstance) { yoyChartInstance.destroy(); yoyChartInstance = null; }
        return;
      }

      rows.sort((a, b) => b.sumB - a.sumB);

      // Totales para el resumen
      let totalA = 0;
      let totalB = 0;
      rows.forEach(r => {
        totalA += r.sumA;
        totalB += r.sumB;
      });
      const totalDiff = totalB - totalA;
      const totalPct = totalA === 0 ? (totalB === 0 ? NaN : Infinity) : (totalDiff / totalA) * 100;

      const totalPctText = isNaN(totalPct)
        ? '‚Äì'
        : (!isFinite(totalPct) ? '‚àû' : totalPct.toFixed(1) + ' %');

      yoySummaryEl.innerHTML = '';
      const span1 = document.createElement('span');
      span1.textContent = monthVal + ' ' + yearA + ': ' + formatNumber(totalA);
      const span2 = document.createElement('span');
      span2.textContent = monthVal + ' ' + yearB + ': ' + formatNumber(totalB);
      const span3 = document.createElement('span');
      span3.textContent = 'Diferencia: ' + formatNumber(totalDiff);
      const span4 = document.createElement('span');
      span4.textContent = 'Var %: ' + totalPctText;
      yoySummaryEl.appendChild(span1);
      yoySummaryEl.appendChild(span2);
      yoySummaryEl.appendChild(span3);
      yoySummaryEl.appendChild(span4);

      // Tabla YoY
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const trHead = document.createElement('tr');
      const headers = [
        groupCol ? 'Grupo ('+groupCol+')' : 'Total',
        metricCol + ' ' + yearA,
        metricCol + ' ' + yearB,
        'Diferencia',
        'Var %'
      ];
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      rows.forEach(r => {
        const tr = document.createElement('tr');
        const tdGroup = document.createElement('td');
        const tdA = document.createElement('td');
        const tdB = document.createElement('td');
        const tdDiff = document.createElement('td');
        const tdPct = document.createElement('td');

        tdGroup.textContent = r.group;
        tdA.textContent = formatNumber(r.sumA);
        tdB.textContent = formatNumber(r.sumB);
        tdDiff.textContent = formatNumber(r.diff);
        const pctText = isNaN(r.pct) ? '‚Äì' : (!isFinite(r.pct) ? '‚àû' : r.pct.toFixed(1) + ' %');
        tdPct.textContent = pctText;

        tr.appendChild(tdGroup);
        tr.appendChild(tdA);
        tr.appendChild(tdB);
        tr.appendChild(tdDiff);
        tr.appendChild(tdPct);
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      yoyTableContainer.appendChild(table);

      // Gr√°fica YoY
      const labels = rows.map(r => r.group);
      const dataA = rows.map(r => r.sumA);
      const dataB = rows.map(r => r.sumB);

      if (yoyChartInstance) {
        yoyChartInstance.destroy();
      }

      yoyChartInstance = new Chart(yoyChartCanvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: yearA, data: dataA },
            { label: yearB, data: dataB }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { color: '#e5e7eb', maxRotation: 45, minRotation: 0 },
              grid: { display: false }
            },
            y: {
              ticks: { color: '#e5e7eb' },
              grid: { color: 'rgba(148,163,184,0.3)' }
            }
          },
          plugins: {
            legend: { labels: { color: '#e5e7eb' } },
            tooltip: {
              callbacks: {
                label: function(ctx) {
                  return ' ' + formatNumber(ctx.raw);
                }
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
