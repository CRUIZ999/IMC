<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Analizador de Ventas ‚Äì Tabla Din√°mica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Estilos b√°sicos -->
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { background: #0f172a; color: #e5e7eb; min-height: 100vh; display: flex; flex-direction: column; }

    header {
      padding: 0.9rem 1.4rem;
      background: linear-gradient(90deg, #ea580c, #f97316);
      color: #0f172a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    header h1 { font-size: 1.4rem; font-weight: 800; display: flex; align-items: center; gap: 0.5rem; }
    header h1 span.logo {
      width: 34px; height: 34px; border-radius: 999px;
      display: inline-flex; align-items: center; justify-content: center;
      background: #0f172a; color: #f97316;
    }
    header .subtitle { font-size: 0.8rem; }

    main {
      max-width: 1500px;
      margin: 0 auto;
      padding: 1.1rem 1.4rem 1.6rem;
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 1rem;
    }
    @media (max-width: 1024px) { main { grid-template-columns: 1fr; } }

    .card {
      background: #020617;
      border-radius: 0.9rem;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 0.9rem 1rem;
      box-shadow: 0 16px 35px rgba(15,23,42,0.8);
    }
    .card h2 {
      font-size: 0.95rem;
      margin-bottom: 0.55rem;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .card h2 .icon { font-size: 1rem; }

    .sidebar { display: flex; flex-direction: column; gap: 0.75rem; }
    .field { margin-bottom: 0.45rem; }
    label { font-size: 0.78rem; color: #9ca3af; margin-bottom: 0.15rem; display: block; }
    input[type="file"] {
      width: 100%;
      padding: 0.4rem 0.55rem;
      border-radius: 0.45rem;
      border: 1px solid rgba(148,163,184,0.5);
      background: #020617;
      color: #e5e7eb;
      font-size: 0.82rem;
      outline: none;
    }
    input[type="file"]:focus {
      border-color: #f97316;
      box-shadow: 0 0 0 1px rgba(249,115,22,0.7);
    }

    .hint { font-size: 0.72rem; color: #9ca3af; margin-top: 0.25rem; line-height: 1.3; }
    hr { border: none; border-top: 1px dashed rgba(148,163,184,0.45); margin: 0.6rem 0; }

    .badge {
      display: inline-block;
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
    }

    #status {
      font-size: 0.78rem;
      color: #e5e7eb;
      margin-top: 0.3rem;
    }

    #output-wrapper {
      background: #020617;
      border-radius: 0.9rem;
      border: 1px solid rgba(148,163,184,0.35);
      padding: 0.6rem;
      box-shadow: 0 16px 35px rgba(15,23,42,0.8);
      overflow: auto;
    }

    footer { padding: 0.7rem 1.4rem 1rem; font-size: 0.7rem; color: #6b7280; text-align: center; }

    /* Ajuste leve del tama√±o de letra de la pivottable */
    .pvtUi, .pvtTable { font-size: 0.78rem; }
  </style>

  <!-- CSS PivotTable -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.css" />

  <!-- Librer√≠as JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/pivot.min.js"></script>
  <!-- Plotly para gr√°ficos -->
  <script src="https://cdn.plot.ly/plotly-2.31.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pivottable@2.23.0/dist/plotly_renderers.min.js"></script>
  <!-- PapaParse para CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <header>
    <div>
      <h1><span class="logo">üìä</span>Analizador de Ventas</h1>
      <div class="subtitle">
        Sube tu archivo de ventas (facturas) y arma tablas din√°micas interactivas, incluyendo comparativos a√±o vs a√±o.
      </div>
    </div>
    <span class="badge">Ferreter√≠a El Cedro</span>
  </header>

  <main>
    <!-- LADO IZQUIERDO -->
    <aside class="sidebar card">
      <h2><span class="icon">üìÇ</span>Cargar datos</h2>
      <div class="field">
        <label for="file-input">Archivo CSV de ventas</label>
        <input type="file" id="file-input" accept=".csv,text/csv" />
        <div class="hint">
          Usa tu archivo con columnas como:<br>
          <code>
          factura, fecha, estatus, descuento, subt_fac, total_fac, iva, id cliente,
          id clase, clave, cant_surt, cve_mon, unidad, cve_suc, id vendedor, cliente,
          producto, cantidad pz, almacen, hora, costoprom2, marca, costo1, vendedor,
          filtro1, filtro2, filtro3, Tipo de Factura, costo2, utilidad, margen, categoria
          </code>
        </div>
        <div id="status">Sin archivo cargado.</div>
      </div>

      <hr />

      <h2><span class="icon">üß©</span>C√≥mo usar la tabla din√°mica</h2>
      <div class="hint">
        Una vez cargado el archivo ver√°s un panel similar a Excel:
        <ul style="margin-left:1rem;margin-top:0.25rem;">
          <li>Lista de campos (columnas) arriba.</li>
          <li>√Åreas de <b>Filas</b>, <b>Columnas</b>, <b>Valores</b> y <b>Filtros</b>.</li>
        </ul>
        Arrastra los campos para construir tu vista de an√°lisis.
      </div>

      <hr />

      <h2><span class="icon">üìÖ</span>Comparar a√±o vs a√±o (mismo mes)</h2>
      <div class="hint">
        El sistema crea campos derivados de <b>fecha</b>: <b>A√±o</b>, <b>Mes</b>, <b>Mes Nombre</b> y <b>A√±o-Mes</b>.<br><br>
        Para comparar, por ejemplo, Noviembre 2024 vs Noviembre 2025:
        <ol style="margin-left:1rem;margin-top:0.25rem;">
          <li>En <b>Filtros</b>, pon <b>Mes Nombre</b> y selecciona ‚Äúnoviembre‚Äù.</li>
          <li>En <b>Columnas</b>, pon <b>A√±o</b>.</li>
          <li>En <b>Filas</b>, pon <b>cve_suc</b> (sucursal) o <b>categoria</b>.</li>
          <li>En <b>Valores</b>, pon <b>total_fac</b> con agregaci√≥n ‚ÄúSum‚Äù.</li>
        </ol>
        Ver√°s cada sucursal/categor√≠a con columnas por a√±o para cotejar r√°pidamente.
        Puedes cambiar ‚ÄúRenderer‚Äù a <b>Plotly Bar Chart</b> para ver la gr√°fica.
      </div>

      <hr />

      <h2><span class="icon">üí°</span>Ideas de an√°lisis</h2>
      <div class="hint">
        - Ventas por sucursal y a√±o ‚Üí Filas: cve_suc, Columnas: A√±o, Valores: total_fac (Sum).<br>
        - Margen por vendedor ‚Üí Filas: vendedor, Valores: margen (Average).<br>
        - Top clientes ‚Üí Filas: cliente, Valores: total_fac (Sum), ordena de mayor a menor.
      </div>
    </aside>

    <!-- LADO DERECHO -->
    <section>
      <div class="card" style="margin-bottom:0.7rem;">
        <h2><span class="icon">‚öôÔ∏è</span>√Årea de an√°lisis interactivo</h2>
        <div class="hint">
          Aqu√≠ aparece la tabla din√°mica. Puedes:
          <ul style="margin-left:1rem;margin-top:0.25rem;">
            <li>Cambiar la agregaci√≥n (Suma, Promedio, Conteo, M√°x, M√≠n, etc.).</li>
            <li>Usar diferentes vistas: tabla, tabla con barras, gr√°ficos de barras, l√≠neas, √°reas, etc.</li>
            <li>Filtrar directo desde los men√∫s de la propia PivotTable.</li>
          </ul>
        </div>
      </div>

      <div id="output-wrapper">
        <div id="output">
          <div style="padding:0.5rem;font-size:0.8rem;color:#9ca3af;">
            Carga un CSV en el panel izquierdo para iniciar el an√°lisis.
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    Panel tipo tabla din√°mica basado en PivotTable.js ‚Äì pensado para las ventas de Ferreter√≠a El Cedro.
  </footer>

  <script>
    // --------- Utilidades para mapear nombres de columnas ---------
    function normalizarNombre(str) {
      return String(str)
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // quita acentos
        .replace(/\s+/g, "")                              // espacios
        .replace(/_/g, "");                               // guiones bajos
    }

    function encontrarColumna(headers, aliases) {
      const normHeaders = headers.map(h => normalizarNombre(h));
      for (const alias of aliases) {
        const normAlias = normalizarNombre(alias);
        const idx = normHeaders.indexOf(normAlias);
        if (idx >= 0) return headers[idx];
      }
      return null;
    }

    // --------- Parse de fecha (para campos derivados) ---------
    function extraerFecha(raw) {
      if (!raw) return null;
      if (raw instanceof Date && !isNaN(raw)) {
        return { year: raw.getFullYear(), month: raw.getMonth() + 1, day: raw.getDate() };
      }
      const s = String(raw).trim();
      if (!s) return null;

      // yyyy-mm-dd o yyyy/mm/dd
      let m = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
      if (m) {
        const y = parseInt(m[1], 10);
        const mo = parseInt(m[2], 10);
        const d = parseInt(m[3], 10);
        if (!isNaN(y) && !isNaN(mo) && !isNaN(d)) return { year: y, month: mo, day: d };
      }

      // dd-mm-yyyy o dd/mm/yyyy (muy t√≠pico en MX)
      m = s.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
      if (m) {
        const d = parseInt(m[1], 10);
        const mo = parseInt(m[2], 10);
        const y = parseInt(m[3], 10);
        if (!isNaN(y) && !isNaN(mo) && !isNaN(d)) return { year: y, month: mo, day: d };
      }

      // fallback al parser de JS
      const d2 = new Date(s);
      if (!isNaN(d2)) {
        return { year: d2.getFullYear(), month: d2.getMonth() + 1, day: d2.getDate() };
      }
      return null;
    }

    const NOMBRES_MESES = [
      "", "enero","febrero","marzo","abril","mayo","junio",
      "julio","agosto","septiembre","octubre","noviembre","diciembre"
    ];

    // --------- Carga de CSV ---------
    document.getElementById('file-input').addEventListener('change', function (e) {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      document.getElementById('status').textContent = 'Leyendo archivo...';

      Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: function (results) {
          const data = results.data || [];
          if (!data.length) {
            document.getElementById('status').textContent = 'El archivo no tiene registros.';
            return;
          }

          const headers = Object.keys(data[0]);

          // Mapear columnas importantes seg√∫n tus nombres
          const fechaCol   = encontrarColumna(headers, ['fecha']);
          const totalCol   = encontrarColumna(headers, ['totalfac','total_fac','total']);
          const sucCol     = encontrarColumna(headers, ['cvesuc','cve_suc','sucursal']);
          const categoriaCol = encontrarColumna(headers, ['categoria','categor√≠a']);
          const vendedorCol  = encontrarColumna(headers, ['vendedor','idvendedor']);

          const meta = {
            fechaCol,
            totalCol,
            sucCol,
            categoriaCol,
            vendedorCol
          };

          document.getElementById('status').textContent =
            'Archivo cargado: ' + file.name + ' (' + data.length + ' filas).';

          crearPivot(data, meta);
        },
        error: function (err) {
          document.getElementById('status').textContent = 'Error al leer el CSV: ' + err.message;
        }
      });
    });

    // --------- Crear tabla din√°mica ---------
    function crearPivot(data, meta) {
      const renderers = $.extend(
        $.pivotUtilities.renderers,
        $.pivotUtilities.plotly_renderers
      );

      const derived = {};

      // Campos derivados a partir de "fecha"
      if (meta.fechaCol) {
        derived["A√±o"] = function (row) {
          const info = extraerFecha(row[meta.fechaCol]);
          return info ? info.year : "";
        };
        derived["Mes"] = function (row) {
          const info = extraerFecha(row[meta.fechaCol]);
          return info ? info.month : "";
        };
        derived["Mes Nombre"] = function (row) {
          const info = extraerFecha(row[meta.fechaCol]);
          return info ? NOMBRES_MESES[info.month] : "";
        };
        derived["A√±o-Mes"] = function (row) {
          const info = extraerFecha(row[meta.fechaCol]);
          if (!info) return "";
          const mm = String(info.month).padStart(2, "0");
          return info.year + "-" + mm;
        };
      }

      // Configuraci√≥n por defecto pensada para tus datos
      const defaultRows = [];
      const defaultCols = [];
      const defaultVals = [];
      let defaultAgg = "Count";

      if (meta.sucCol) defaultRows.push(meta.sucCol);
      if (meta.fechaCol) defaultCols.push("A√±o");   // usamos derivado
      if (meta.totalCol) {
        defaultVals.push(meta.totalCol);
        defaultAgg = "Sum";
      }

      $("#output").pivotUI(
        data,
        {
          renderers: renderers,
          derivedAttributes: derived,
          rows: defaultRows,
          cols: defaultCols,
          vals: defaultVals,
          aggregatorName: defaultAgg,
          rendererName: "Table"
        },
        true
      );
    }
  </script>
</body>
</html>
